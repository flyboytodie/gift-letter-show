{"mappings":"ACCA,IAAI,MAAQ,EAAE,CACV,iBAAmB,GACnB,MAAQ,KACR,MAAQ,KACR,UAAY,KACZ,SAAW,KACX,QAAU,KACV,YAAc,KACd,OAAS,KAIb,MAAM,WAAa,wBAGnB,SAAS,uBACL,IAAM,EAAY,aAAa,OAAO,CAAC,kBACvC,GAAI,EACA,GAAI,CACA,IAAM,EAAO,KAAK,KAAK,CAAC,GAKxB,GAJA,MAAQ,EAAK,KAAK,EAAI,EAAE,CACxB,SAAW,EAAK,QAAQ,EAAI,KAGd,CAEV,IAEU,EAFJ,EAAW,EAAK,SAAS,GAErB,EAAW,SAAS,KAAK,CAAC,KACjB,CAAC,EAAS,MAAM,CAAG,EAAE,AAExC,CAAA,SAAS,cAAc,CAAC,cAAc,WAAW,CAAG,EAGpD,IAAM,EAAuB,SAAS,cAAc,CAAC,kBACjD,IACA,EAAqB,WAAW,CAAG,EACnC,EAAqB,KAAK,CAAC,KAAK,CAAG,QAInC,OACA,MAAM,MAAM,GAEhB,MAAQ,IAAI,KAAK,CACb,IAAK,CAAC,SAAS,CACf,KAAM,CAAA,EACN,OAAQ,WAAW,SAAS,cAAc,CAAC,UAAU,KAAK,CAC9D,EACJ,KAAO,CACH,SAAS,cAAc,CAAC,cAAc,WAAW,CAAG,MAGpD,IAAM,EAAuB,SAAS,cAAc,CAAC,kBACjD,IACA,EAAqB,WAAW,CAAG,MACnC,EAAqB,KAAK,CAAC,KAAK,CAAG,OAE3C,CAGI,EAAK,KAAK,GACV,SAAS,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,OAAQ,QAAS,QAChD,SAAS,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,EAAK,KAAK,EAItC,AADkB,SAAS,gBAAgB,CAAC,cAClC,OAAO,CAAC,AAAA,IACV,EAAI,OAAO,CAAC,KAAK,GAAK,EAAK,KAAK,CAChC,EAAI,SAAS,CAAC,GAAG,CAAC,UAElB,EAAI,SAAS,CAAC,MAAM,CAAC,SAE7B,IAIA,EAAK,SAAS,EACd,CAAA,SAAS,cAAc,CAAC,cAAc,KAAK,CAAG,EAAK,SAAS,AAAT,EAEnD,EAAK,WAAW,EAChB,CAAA,SAAS,cAAc,CAAC,gBAAgB,KAAK,CAAG,EAAK,WAAW,AAAX,EAGrD,EAAK,aAAa,EAAI,OACtB,CAAA,MAAM,IAAI,CAAC,SAAS,CAAG,EAAK,aAAa,AAAb,EAGhC,aACJ,CAAE,MAAO,EAAO,CACZ,QAAQ,KAAK,CAAC,UAAW,EAC7B,CAER,CAGA,SAAS,qBAEL,IAAM,EAAe,SAAS,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,QAAU,OAC5C,SAAS,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,SAAW,QAAU,OAEpE,EAAO,CACT,MAAO,MACP,SAAU,SACV,UAAW,UAAY,UAAU,IAAI,CAAG,KACxC,UAAW,SAAS,cAAc,CAAC,cAAc,KAAK,CACtD,YAAa,SAAS,cAAc,CAAC,gBAAgB,KAAK,CAC1D,cAAe,MAAQ,MAAM,IAAI,CAAC,SAAS,CAAG,GAC9C,MAAO,CACX,EACA,aAAa,OAAO,CAAC,iBAAkB,KAAK,SAAS,CAAC,IACtD,QAAQ,GAAG,CAAC,aAChB,CAGA,eAAe,gBACX,GAAI,CAEA,IAAM,EAAe,SAAS,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,QAAU,OAC5C,SAAS,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,SAAW,QAAU,OAEpE,EAAO,CACT,OAAQ,OACR,MAAO,MACP,SAAU,SACV,UAAW,UAAY,UAAU,IAAI,CAAG,KACxC,UAAW,SAAS,cAAc,CAAC,cAAc,KAAK,CACtD,YAAa,SAAS,cAAc,CAAC,gBAAgB,KAAK,CAC1D,cAAe,MAAQ,MAAM,IAAI,CAAC,SAAS,CAAG,GAC9C,MAAO,CACX,EAEM,EAAW,MAAM,MAAM,CAAA,EAAG,WAAW,cAAc,CAAC,CAAE,CACxD,OAAQ,OACR,QAAS,CACL,eAAgB,kBACpB,EACA,KAAM,KAAK,SAAS,CAAC,EACzB,GAEM,EAAS,MAAM,EAAS,IAAI,GAClC,GAAI,EAAO,OAAO,CAOd,OANA,OAAS,EAAO,MAAM,CACtB,QAAQ,GAAG,CAAC,cACZ,eAAe,iBAGf,sBACO,EAAO,MAAM,AAE5B,CAAE,MAAO,EAAO,CACZ,QAAQ,KAAK,CAAC,YAAa,EAC/B,CACA,OAAO,IACX,CAGA,SAAS,eAAe,CAAO,EAE3B,IAAI,EAAa,SAAS,cAAc,CAAC,eACpC,IAED,AADA,CAAA,EAAa,SAAS,aAAa,CAAC,MAApC,EACW,EAAE,CAAG,cAChB,EAAW,KAAK,CAAC,OAAO,CAAG;A;A;A;A;A;A;A;A;A;A;A;AAY3B,QAAA,CAAC,CACD,SAAS,IAAI,CAAC,WAAW,CAAC,IAI9B,EAAW,WAAW,CAAG,EACzB,EAAW,KAAK,CAAC,OAAO,CAAG,IAC3B,EAAW,KAAK,CAAC,SAAS,CAAG,gBAG7B,WAAW,KACP,EAAW,KAAK,CAAC,OAAO,CAAG,IAC3B,EAAW,KAAK,CAAC,SAAS,CAAG,mBACjC,EAAG,IACP,CAGA,eAAe,cAAc,CAAU,EACnC,GAAI,CACA,IAAM,EAAW,MAAM,MAAM,CAAA,EAAG,WAAW,sBAAsB,EAAE,EAAA,CAAY,EACzE,EAAS,MAAM,EAAS,IAAI,GAClC,GAAI,EAAO,OAAO,CAAE,CAChB,IAAM,EAAO,EAAO,IAAI,CAMxB,GALA,OAAS,EAAK,MAAM,CACpB,MAAQ,EAAK,KAAK,EAAI,EAAE,CACxB,SAAW,EAAK,QAAQ,EAAI,KAGd,CAEV,IAEU,EAFJ,EAAW,EAAK,SAAS,GAErB,EAAW,SAAS,KAAK,CAAC,KACjB,CAAC,EAAS,MAAM,CAAG,EAAE,AAExC,CAAA,SAAS,cAAc,CAAC,cAAc,WAAW,CAAG,EAGpD,IAAM,EAAuB,SAAS,cAAc,CAAC,kBACjD,IACA,EAAqB,WAAW,CAAG,EACnC,EAAqB,KAAK,CAAC,KAAK,CAAG,QAInC,OACA,MAAM,MAAM,GAEhB,MAAQ,IAAI,KAAK,CACb,IAAK,CAAC,SAAS,CACf,KAAM,CAAA,EACN,OAAQ,WAAW,SAAS,cAAc,CAAC,UAAU,KAAK,CAC9D,EACJ,KAAO,CACH,SAAS,cAAc,CAAC,cAAc,WAAW,CAAG,MAGpD,IAAM,EAAuB,SAAS,cAAc,CAAC,kBACjD,IACA,EAAqB,WAAW,CAAG,MACnC,EAAqB,KAAK,CAAC,KAAK,CAAG,OAE3C,CAkCA,OA/BI,EAAK,KAAK,GACV,SAAS,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,OAAQ,QAAS,QAChD,SAAS,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,EAAK,KAAK,EAItC,AADkB,SAAS,gBAAgB,CAAC,cAClC,OAAO,CAAC,AAAA,IACV,EAAI,OAAO,CAAC,KAAK,GAAK,EAAK,KAAK,CAChC,EAAI,SAAS,CAAC,GAAG,CAAC,UAElB,EAAI,SAAS,CAAC,MAAM,CAAC,SAE7B,IAIA,EAAK,SAAS,EACd,CAAA,SAAS,cAAc,CAAC,cAAc,KAAK,CAAG,EAAK,SAAS,AAAT,EAEnD,EAAK,WAAW,EAChB,CAAA,SAAS,cAAc,CAAC,gBAAgB,KAAK,CAAG,EAAK,WAAW,AAAX,EAGrD,EAAK,aAAa,EAAI,OACtB,CAAA,MAAM,IAAI,CAAC,SAAS,CAAG,EAAK,aAAa,AAAb,EAGhC,cAEA,eAAe,iBAER,CAAA,CACX,CACJ,CAAE,MAAO,EAAO,CACZ,QAAQ,KAAK,CAAC,YAAa,GAC3B,eAAe,WACnB,CACA,MAAO,CAAA,CACX,CAGA,SAAS,mBAAmB,CAAI,EAC5B,OAAO,IAAI,QAAQ,CAAC,EAAS,KACzB,IAAM,EAAW,IAAI,SACrB,EAAS,MAAM,CAAC,OAAQ,GAExB,MAAM,CAAA,EAAG,WAAW,WAAW,CAAC,CAAE,CAC9B,OAAQ,OACR,KAAM,CACV,GACC,IAAI,CAAC,AAAA,IACF,GAAI,CAAC,EAAS,EAAE,CACZ,MAAM,AAAI,MAAM,iBAEpB,OAAO,EAAS,IAAI,EACxB,GACC,IAAI,CAAC,AAAA,IACE,EAAK,KAAK,CACV,EAAO,EAAK,KAAK,EAEjB,EAAQ,EAAK,GAAG,CAExB,GACC,KAAK,CAAC,AAAA,IACH,QAAQ,KAAK,CAAC,gBAAiB,GAC/B,EAAO,EACX,EACJ,EACJ,CAGA,SAAS,mBACL,IAAM,EAAa,SAAS,cAAc,CAAC,eACrC,EAAc,SAAS,cAAc,CAAC,gBAExC,GAAc,IAEd,EAAW,gBAAgB,CAAC,SAAU,WAClC,IAAM,EAAe,IAAI,CAAC,KAAK,CAS/B,GANA,EAAY,KAAK,CAAC,UAAU,CAAG,EAG/B,SAAS,IAAI,CAAC,KAAK,CAAC,UAAU,CAAG,EAG7B,MAAO,CACP,IAAM,EAAS,SAAS,aAAa,CAAC,aAClC,CAAA,GACA,CAAA,EAAO,KAAK,CAAC,UAAU,CAAG,CAD9B,CAGJ,CAIA,AADkB,SAAS,gBAAgB,CAAC,cAClC,OAAO,CAAC,AAAA,IACd,EAAK,KAAK,CAAC,UAAU,CAAG,CAC5B,GAEA,QAAQ,GAAG,CAAC,UAAW,EAC3B,GAGA,EAAY,KAAK,CAAC,UAAU,CAAG,EAAW,KAAK,CAEvD,CAGA,SAAS,WACL,YACA,kBACA,qBACA,kBACA,sBACA,aACA,eACA,mBAGA,IAAM,EAAW,SAAS,cAAc,CAAC,YACzC,CAAA,EAAS,SAAS,CAAG,EAAS,SAAS,CAIvC,IAAM,EAAY,AADA,IAAI,gBAAgB,OAAO,QAAQ,CAAC,MAAM,EAChC,GAAG,CAAC,UAC5B,EAEA,WAAW,KACP,cAAc,EAClB,EAAG,KAGH,uBAIJ,eACJ,CAGA,SAAS,YAqBL,AApBA,CAAA,MAAQ,IAAI,MAAM,kBAAmB,CACjC,MAAO,OACP,QAAS,CACL,QAAS,CACL,CAAC,OAAQ,SAAU,YAAY,CAC/B,CAAC,aAAc,aAAa,CAC5B,CAAC,CAAE,OAAU,CAAE,EAAG,CAAE,OAAU,CAAE,EAAE,CAClC,CAAC,CAAE,KAAQ,SAAU,EAAG,CAAE,KAAQ,QAAS,EAAE,CAC7C,CAAC,CAAE,MAAS,EAAE,AAAC,EAAG,CAAE,WAAc,EAAE,AAAC,EAAE,CACvC,CAAC,CAAE,MAAS,EAAE,AAAC,EAAE,CACjB,CAAC,QAAQ,CACZ,AACL,EACA,YAAa,aAEb,QAAS,CAAC,OAAQ,OAAQ,OAAQ,SAAU,YAAa,SAAU,aAAc,aAAc,SAAU,OAAQ,SAAU,SAAU,OAAQ,QAAS,QAAS,aAAc,QAAQ,CACrL,YAAa,YACjB,EAAA,EAGM,EAAE,CAAC,gBAAiB,WACtB,IAAM,EAAS,SAAS,aAAa,CAAC,cAClC,IACA,EAAO,KAAK,CAAC,UAAU,CAAG,+DAC1B,EAAO,KAAK,CAAC,QAAQ,CAAG,OAEhC,EACJ,CAGA,SAAS,kBACL,IAAM,EAAY,SAAS,gBAAgB,CAAC,cAC5C,EAAU,OAAO,CAAC,AAAA,IACd,EAAI,gBAAgB,CAAC,QAAS,KAE1B,EAAU,OAAO,CAAC,AAAA,GAAK,EAAE,SAAS,CAAC,MAAM,CAAC,WAE1C,EAAI,SAAS,CAAC,GAAG,CAAC,UAElB,IAAM,EAAQ,EAAI,OAAO,CAAC,KAAK,AAC/B,CAAA,SAAS,IAAI,CAAC,SAAS,CAAG,CAC9B,EACJ,EACJ,CAGA,SAAS,qBAEL,SAAS,cAAc,CAAC,YAAY,gBAAgB,CAAC,QAAS,KAC1D,iBAAmB,GACnB,eACJ,EACJ,CAGA,SAAS,gBAML,GALA,SAAS,cAAc,CAAC,cAAc,KAAK,CAAC,OAAO,CAAG,QAEtD,SAAS,cAAc,CAAC,aAAa,KAAK,CAAG,GAGzC,AAAqB,KAArB,iBAAyB,CACzB,SAAS,cAAc,CAAC,aAAa,KAAK,CAAG,GAC7C,IAAM,EAAsB,SAAS,cAAc,CAAC,yBAC9C,EAAsB,SAAS,cAAc,CAAC,wBACpD,CAAA,EAAoB,KAAK,CAAC,OAAO,CAAG,OACpC,EAAoB,SAAS,CAAG,EACpC,CACJ,CAGA,SAAS,iBACL,SAAS,cAAc,CAAC,cAAc,KAAK,CAAC,OAAO,CAAG,MAC1D,CAGA,SAAS,iBAAiB,CAAC,EACvB,IAAM,EAAO,EAAE,MAAM,CAAC,KAAK,CAAC,EAAE,CACzB,IAEL,YAAc,EAEV,EAAK,IAAI,CAAC,UAAU,CAAC,UAErB,cAAc,GAGd,iBAAiB,GAEzB,CAGA,SAAS,cAAc,CAAI,EACvB,IAAM,EAAS,IAAI,UACnB,CAAA,EAAO,MAAM,CAAG,SAAS,CAAC,EACtB,IAAM,EAAM,SAAS,cAAc,CAAC,aACpC,CAAA,EAAI,GAAG,CAAG,EAAE,MAAM,CAAC,MAAM,CAGrB,SACA,QAAQ,OAAO,GAGnB,QAAU,IAAI,QAAQ,EAAK,CACvB,YAAa,EACb,SAAU,EACV,SAAU,OACV,aAAc,GACd,eAAgB,CAAA,EAChB,iBAAkB,CAAA,CACtB,GAGA,SAAS,cAAc,CAAC,cAAc,KAAK,CAAC,OAAO,CAAG,OAC1D,EACA,EAAO,aAAa,CAAC,EACzB,CAGA,SAAS,iBACD,UACA,QAAQ,OAAO,GACf,QAAU,MAEd,SAAS,cAAc,CAAC,cAAc,KAAK,CAAC,OAAO,CAAG,OACtD,YAAc,IAClB,CAGA,IAAI,YAAc,KAEd,aAAe,CAAA,EAGnB,eAAe,cACX,GAAI,AAAC,UAAW,aAEhB,GAAI,CACA,QAAQ,GAAG,CAAC,UAEZ,aAAe,CAAA,EAWf,AARe,QAAQ,gBAAgB,CAAC,CACpC,MAAO,IACP,OAAQ,IACR,UAAW,OACX,sBAAuB,CAAA,CAC3B,GAGO,MAAM,CAAC,SAAS,CAAI,EACvB,QAAQ,GAAG,CAAC,eAEZ,YAAc,IAAI,KAAK,CAAC,EAAK,CAAE,YAAY,IAAI,CAAE,CAC7C,KAAM,YAAY,IAAI,CACtB,aAAc,KAAK,GAAG,EAC1B,GAEA,QAAQ,GAAG,CAAC,UAEZ,iBAEA,QAAQ,GAAG,CAAC,UAEZ,MAAM,6BAGN,QAAQ,GAAG,CAAC,uBAGZ,aAAe,CAAA,CACnB,EAAG,YAAY,IAAI,CACvB,CAAE,MAAO,EAAO,CACZ,QAAQ,KAAK,CAAC,QAAS,GACvB,MAAM,sBAGN,aAAe,CAAA,CACnB,CACJ,CAGA,eAAe,iBAAiB,CAAI,EAChC,GAAI,aAAc,OAGlB,IAAM,EAAO,AADK,SAAS,cAAc,CAAC,aACnB,KAAK,CAE5B,GAAI,KASI,EARJ,QAAQ,GAAG,CAAC,UAAW,EAAK,IAAI,EAEhC,aAAe,CAAA,EAGf,IAAM,EAAM,MAAM,mBAAmB,GACrC,QAAQ,GAAG,CAAC,cAAe,GAGvB,AAAqB,KAArB,kBAEA,EAAO,CACH,GAAI,KAAK,GAAG,GACZ,KAAM,EACN,IAAK,EACL,KAAM,EACN,KAAM,EAAK,IAAI,CAAC,UAAU,CAAC,UAAY,QAAU,OACrD,EACA,MAAM,IAAI,CAAC,GACX,QAAQ,GAAG,CAAC,WAAY,EAAK,EAAE,IAI/B,AADA,CAAA,EAAO,KAAK,CAAC,iBAAiB,AAAjB,EACR,IAAI,CAAG,EACZ,EAAK,GAAG,CAAG,EACX,EAAK,IAAI,CAAG,EACZ,EAAK,IAAI,CAAG,EAAK,IAAI,CAAC,UAAU,CAAC,UAAY,QAAU,QAEvD,QAAQ,GAAG,CAAC,UAAW,EAAK,EAAE,GAIlC,cAEA,iBAEA,qBAEA,eAAe,eAEf,QAAQ,GAAG,CAAC,SAChB,CAAE,MAAO,EAAO,CACZ,QAAQ,KAAK,CAAC,UAAW,GACzB,QAAQ,KAAK,CAAC,QAAS,EAAM,OAAO,EAEpC,MAAM,+BAAiC,EAAM,OAAO,CAExD,QAAU,CAEN,aAAe,CAAA,EAEf,YAAc,IAClB,CACJ,CAGA,SAAS,WACL,GAAI,aAAc,YACd,MAAM,sBAKV,IAAM,EAAY,SAAS,cAAc,CAAC,aAEpC,EAAO,AADK,SAAS,cAAc,CAAC,aACnB,KAAK,CAS5B,GAPA,QAAQ,GAAG,CAAC,UACZ,QAAQ,GAAG,CAAC,oBAAqB,kBACjC,QAAQ,GAAG,CAAC,0BAA2B,EAAU,KAAK,CAAC,MAAM,EAC7D,QAAQ,GAAG,CAAC,eAAgB,aAC5B,QAAQ,GAAG,CAAC,QAAS,GAGjB,AAAqB,KAArB,kBAA2B,CAAC,EAAU,KAAK,CAAC,MAAM,EAAI,CAAC,YAAa,CACpE,QAAQ,GAAG,CAAC,gBAGZ,AAFa,KAAK,CAAC,iBAAiB,CAE/B,IAAI,CAAG,EAEZ,cAEA,iBAEA,qBAEA,eAAe,iBAEf,MACJ,CAGA,GAAI,YACA,QAAQ,GAAG,CAAC,gBAEZ,iBAAiB,kBACd,GAAI,EAAU,KAAK,CAAC,MAAM,CAC7B,QAAQ,GAAG,CAAC,aAEZ,iBAAiB,CAAE,OAAQ,CAAU,OAClC,CACH,QAAQ,GAAG,CAAC,UACZ,MAAM,iBACN,MAEJ,CACJ,CAGA,SAAS,cACL,IAAM,EAAW,SAAS,cAAc,CAAC,YACzC,CAAA,EAAS,SAAS,CAAG,GAErB,MAAM,OAAO,CAAC,CAAC,EAAM,KACjB,IAAM,EAAW,SAAS,aAAa,CAAC,MACxC,CAAA,EAAS,SAAS,CAAG,YAErB,IAAI,EAAe,GAEf,EADA,AAAc,UAAd,EAAK,IAAI,CACM,CAAC,UAAU,EAAE,EAAK,GAAG,CAAC;AACjD,0CAA0C,EAAE,EAAM,gDAAkC,CAAC,CAE1D,CAAC,YAAY,EAAE,EAAK,GAAG,CAAC;AACnD,8GAAgG,CAAC,CAGzF,EAAS,SAAS,CAAG;A;AAEb,gBAAA,EAAE;A;AAEiB,mCAAA,EAAE,EAAK,IAAI,EAAI,MAAM;A;AAEd,0CAAA,EAAE,EAAM;AAClD,kDAAkD,EAAE,EAAM;AAC1D;AACA,QAAQ,CAAC,CAED,EAAS,WAAW,CAAC,EACzB,EACJ,CAGA,SAAS,0BACL,IAAM,EAAW,SAAS,cAAc,CAAC,aAGzC,EAAS,gBAAgB,CAAC,QAAS,SAAS,CAAC,EACzC,GAAI,AAAqB,QAArB,EAAE,MAAM,CAAC,OAAO,EAAc,AAAqB,UAArB,EAAE,MAAM,CAAC,OAAO,CAAc,CAG5D,IAAM,EAAQ,SAAS,AADL,AADD,EAAE,MAAM,CAAC,OAAO,CAAC,cACP,aAAa,CAAC,eACR,OAAO,CAAC,KAAK,EACzC,MAAM,KACH,AAAqB,QAArB,EAAE,MAAM,CAAC,OAAO,CAChB,aAAa,GACN,AAAqB,UAArB,EAAE,MAAM,CAAC,OAAO,EACvB,EAAE,MAAM,CAAC,IAAI,GAGzB,CACJ,GAGA,EAAS,gBAAgB,CAAC,QAAS,SAAS,CAAC,EACzC,GAAI,EAAE,MAAM,CAAC,SAAS,CAAC,QAAQ,CAAC,YAAa,CACzC,EAAE,eAAe,GACjB,IAAM,EAAQ,SAAS,EAAE,MAAM,CAAC,OAAO,CAAC,KAAK,CACzC,CAAC,MAAM,IACP,SAAS,EAEjB,CACJ,EAGJ,CAGA,SAAS,iBAAiB,CAAK,EAC3B,QAAQ,GAAG,CAAC,cAAe,GAC3B,QAAQ,GAAG,CAAC,eAAgB,MAAM,MAAM,EAGpC,GAAS,GAAK,EAAQ,MAAM,MAAM,EAElC,MAAM,MAAM,CAAC,EAAO,GACpB,QAAQ,GAAG,CAAC,gBAAiB,MAAM,MAAM,EAEzC,cAEA,qBACA,eAAe,kBAEf,QAAQ,KAAK,CAAC,UAAW,GACzB,MAAM,uBAEd,CAGA,SAAS,SAAS,CAAK,EACnB,iBAAmB,EACnB,IAAM,EAAO,KAAK,CAAC,EAAM,AACzB,CAAA,SAAS,cAAc,CAAC,aAAa,KAAK,CAAG,EAAK,IAAI,CAGtD,IAAM,EAAsB,SAAS,cAAc,CAAC,yBAC9C,EAAsB,SAAS,cAAc,CAAC,wBAEhD,CAAA,GAAQ,EAAK,GAAG,EAEhB,EAAoB,KAAK,CAAC,OAAO,CAAG,QAGhC,AAAc,UAAd,EAAK,IAAI,CACT,EAAoB,SAAS,CAAG,CAAC,UAAU,EAAE,EAAK,GAAG,CAAC,yGAA6E,CAAC,CAC7H,AAAc,UAAd,EAAK,IAAI,EAChB,CAAA,EAAoB,SAAS,CAAG,CAAC,YAAY,EAAE,EAAK,GAAG,CAAC,mFAAmF,CAAC,AAAD,IAI/I,EAAoB,KAAK,CAAC,OAAO,CAAG,OACpC,EAAoB,SAAS,CAAG,IAGpC,eACJ,CAGA,SAAS,WAAW,CAAK,EACrB,QAAQ,GAAG,CAAC,cAAe,GAC3B,QAAQ,GAAG,CAAC,eAAgB,MAAM,MAAM,EACxC,QAAQ,GAAG,CAAC,aAAc,OAG1B,IAAM,EAAY,QAAQ,uBAC1B,QAAQ,GAAG,CAAC,QAAS,GAEjB,GACA,QAAQ,GAAG,CAAC,aAAc,GACtB,GAAS,GAAK,EAAQ,MAAM,MAAM,EAElC,MAAM,MAAM,CAAC,EAAO,GACpB,QAAQ,GAAG,CAAC,gBAAiB,MAAM,MAAM,EAEzC,cAEA,qBACA,eAAe,YAEf,QAAQ,KAAK,CAAC,UAAW,GACzB,MAAM,iBAGV,QAAQ,GAAG,CAAC,WAEpB,CAGA,SAAS,aAAa,CAAK,EACvB,IAAM,EAAO,KAAK,CAAC,EAAM,AACrB,AAAc,CAAA,UAAd,EAAK,IAAI,EAET,QAAQ,GAAG,CAAC,QAAS,EAAK,GAAG,CAErC,CAKA,SAAS,sBAEL,SAAS,cAAc,CAAC,eAAe,gBAAgB,CAAC,QAAS,WAC7D,iBACJ,GAGA,SAAS,cAAc,CAAC,gBAAgB,gBAAgB,CAAC,QAAS,WAC9D,qBACJ,EACJ,CAGA,SAAS,kBACL,IAAM,EAAiB,SAAS,cAAc,CAAC,mBACzC,EAAY,SAAS,cAAc,CAAC,cAAc,KAAK,CACvD,EAAc,SAAS,cAAc,CAAC,gBAAgB,KAAK,CAC3D,EAAgB,MAAM,IAAI,CAAC,SAAS,CAGtC,EAAO;AACH,YAAA,EAAE,EAAU;AAAM;AACX;AACW,IAC1B,CAAC,CAED,MAAM,OAAO,CAAC,AAAA,IACV,IAAI,EAAe,GAEf,EADA,AAAc,UAAd,EAAK,IAAI,CACM,CAAC,UAAU,EAAE,EAAK,GAAG,CAAC,4DAAgC,CAAC,CAEvD,CAAC,YAAY,EAAE,EAAK,GAAG,CAAC,6BAA6B,CAAC,CAGzE,GAAQ;A;A;AAGI,oBAAA,EAAE;A;AAEiB,uCAAA,EAAE,EAAK,IAAI,EAAI,MAAM;A;AAEpD,QAAA,CAAC,AACL,GAWA,EAAe,SAAS,CATxB,GAAQ;A;AAEA,YAAA,EAAE,EAAY;AACU,oCAAA,EAAE,EAAc;AAAO;AACzB,oDACV,EAAE,UAAY,UAAU,IAAI,CAAG,MAAM;A;AAEzD,IAAA,CAAC,CAGD,SAAS,cAAc,CAAC,iBAAiB,KAAK,CAAC,OAAO,CAAG,OAC7D,CAGA,eAAe,sBACX,GAAI,CAEA,MAAM,gBAEN,IAAM,EAAY,SAAS,cAAc,CAAC,cAAc,KAAK,EAAI,OAC3D,EAAc,SAAS,cAAc,CAAC,gBAAgB,KAAK,EAAI,OAC/D,EAAgB,MAAM,IAAI,CAAC,SAAS,CAGpC,EAAe,SAAS,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,QAAU,OAC5C,SAAS,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,SAAW,QAAU,OAGpE,EAAW,CACb,UAAW,EACX,YAAa,EACb,cAAe,EACf,MAAO,MAAM,GAAG,CAAC,AAAA,GAAS,CAAA,CACtB,GAAI,EAAK,EAAE,CACX,IAAK,EAAK,GAAG,CACb,KAAM,EAAK,IAAI,CACf,KAAM,EAAK,IAAI,AACnB,CAAA,GACA,SAAU,SACV,UAAW,UAAY,UAAU,IAAI,CAAG,KACxC,MAAO,CACX,EAGM,EAAW,MAAM,MAAM,CAAA,EAAG,WAAW,cAAc,CAAC,CAAE,CACxD,OAAQ,OACR,QAAS,CACL,eAAgB,kBACpB,EACA,KAAM,KAAK,SAAS,CAAC,EACzB,GAEM,EAAS,MAAM,EAAS,IAAI,GAElC,GAAI,EAAO,OAAO,CAAE,CAEhB,IAAI,EAAW,EACX,CAAA,QACA,CAAA,EAAW,CAAC;AAA+C;AACqC,oBAC5F,EAAE,WAAW,kBAAkB,EAAE;AACjC,oBAAA,CAAC,AAAD,EAGR,SAAS,cAAc,CAAC,iBAAiB,SAAS,CAAG;AAAE;AACL;AACiD,oBAC3F,EAAE,EAAO,QAAQ;A;AAErB,gBAAA,EAAE;AAAU;AACiC,YACjD,CAAC,CAGD,GAAI,CACA,MAAM,UAAU,SAAS,CAAC,SAAS,CAAC,EAAO,QAAQ,EACnD,SAAS,cAAc,CAAC,iBAAiB,SAAS,EAAI;AAAE;AACO,gBAC/D,CAAC,AACL,CAAE,MAAO,EAAgB,CACrB,QAAQ,GAAG,CAAC,YAAa,EAC7B,CACJ,MACI,SAAS,cAAc,CAAC,iBAAiB,SAAS,CAAG;AAAE,yEACtB,EAAE,EAAO,KAAK,CAAC;AAChD,YAAA,CAAC,AAET,CAAE,MAAO,EAAO,CACZ,QAAQ,KAAK,CAAC,YAAa,GAC3B,SAAS,cAAc,CAAC,iBAAiB,SAAS,CAAG;AAAE;AACf,QACxC,CAAC,AACL,CACJ,CAGA,SAAS,sBACL,IAAM,EAAuB,SAAS,cAAc,CAAC,mBACjD,IACI,OACA,EAAqB,WAAW,CAAG,CAAC,oCAAQ,EAAE,OAAO,2EAAY,CAAC,CAElE,EAAqB,WAAW,CAAG,UAG/C,CAGA,SAAS,aAEL,SAAS,aAAa,CAAC,sBAAsB,gBAAgB,CAAC,QAAS,gBAGvE,SAAS,aAAa,CAAC,yBAAyB,gBAAgB,CAAC,QAAS,WACtE,SAAS,cAAc,CAAC,iBAAiB,KAAK,CAAC,OAAO,CAAG,MAC7D,GAGA,SAAS,aAAa,CAAC,sBAAsB,gBAAgB,CAAC,QAAS,gBACvE,SAAS,cAAc,CAAC,eAAe,gBAAgB,CAAC,QAAS,gBACjE,SAAS,cAAc,CAAC,gBAAgB,gBAAgB,CAAC,QAAS,aAGlE,OAAO,gBAAgB,CAAC,QAAS,SAAS,CAAC,EACvC,IAAM,EAAY,SAAS,cAAc,CAAC,cACpC,EAAe,SAAS,cAAc,CAAC,iBACvC,EAAY,SAAS,cAAc,CAAC,aAEtC,CAAA,EAAE,MAAM,GAAK,GACb,iBAGA,EAAE,MAAM,GAAK,GACb,CAAA,EAAa,KAAK,CAAC,OAAO,CAAG,MADjC,EAII,EAAE,MAAM,GAAK,GACb,gBAER,GAGA,SAAS,cAAc,CAAC,aAAa,gBAAgB,CAAC,QAAS,UAG/D,SAAS,cAAc,CAAC,aAAa,gBAAgB,CAAC,SAAU,kBAGhE,SAAS,cAAc,CAAC,cAAc,gBAAgB,CAAC,QAAS,oBAChE,SAAS,cAAc,CAAC,gBAAgB,gBAAgB,CAAC,QAAS,oBAGlE,WAAW,KACH,QACA,MAAM,EAAE,CAAC,cAAe,oBACxB,QAAQ,GAAG,CAAC,kBAEpB,EAAG,KAGH,IAAM,EAAc,SAAS,cAAc,CAAC,gBACxC,CAAA,GACA,EAAY,gBAAgB,CAAC,QAAS,WAElC,IAAM,EAAc,AADA,SAAS,cAAc,CAAC,iBACZ,KAAK,CAAC,IAAI,GACtC,EACA,cAAc,GAEd,MAAM,UAEd,EAER,CAGA,SAAS,eAEL,IAAI,SADa,SAAS,cAAc,CAAC,aAClB,CACnB,UAAW,IACX,WAAY,iBACZ,YAAa,kBACb,UAAW,gBACX,QAAS,SAAS,CAAG,EAGjB,AADuB,EAAI,IAAI,CAChB,KAAK,CAAC,OAAO,CAAG,KACnC,EACA,MAAO,SAAS,CAAG,EAGf,AADuB,EAAI,IAAI,CAChB,KAAK,CAAC,OAAO,CAAG,IAG/B,IAAM,EAAc,MAAM,MAAM,CAAC,EAAI,QAAQ,CAAE,EAAE,CAAC,EAAE,CACpD,MAAM,MAAM,CAAC,EAAI,QAAQ,CAAE,EAAG,GAE9B,cAEA,qBACA,eAAe,UACnB,CACJ,EACJ,CAGA,SAAS,kBAEL,SAAS,cAAc,CAAC,oBAAoB,gBAAgB,CAAC,QAAS,WAClE,SAAS,cAAc,CAAC,gBAAgB,KAAK,EACjD,GAGA,SAAS,cAAc,CAAC,gBAAgB,gBAAgB,CAAC,SAAU,eAAe,CAAC,EAC/E,IAAM,EAAO,EAAE,MAAM,CAAC,KAAK,CAAC,EAAE,CAC9B,GAAI,GAAQ,EAAK,IAAI,CAAC,UAAU,CAAC,UAC7B,GAAI,CAEA,SAAS,cAAc,CAAC,cAAc,WAAW,CAAG,SAGpD,IAAM,EAAM,MAAM,mBAAmB,GAGjC,OACA,MAAM,MAAM,GACZ,eAAe,cAEf,eAAe,eAGnB,UAAY,EACZ,SAAW,EACX,SAAS,cAAc,CAAC,cAAc,WAAW,CAAG,EAAK,IAAI,CAG7D,IAAM,EAAuB,SAAS,cAAc,CAAC,kBACjD,IACA,EAAqB,WAAW,CAAG,EAAK,IAAI,CAC5C,EAAqB,KAAK,CAAC,KAAK,CAAG,QAIvC,MAAQ,IAAI,KAAK,CACb,IAAK,CAAC,EAAI,CACV,KAAM,CAAA,EACN,OAAQ,WAAW,SAAS,cAAc,CAAC,UAAU,KAAK,CAC9D,GAGA,oBAEJ,CAAE,MAAO,EAAO,CACZ,QAAQ,KAAK,CAAC,UAAW,GACzB,SAAS,cAAc,CAAC,cAAc,WAAW,CAAG,OACpD,MAAM,uBAEV,MACO,GACP,MAAM,eAEd,GAGA,SAAS,cAAc,CAAC,eAAe,gBAAgB,CAAC,QAAS,WACzD,QACA,MAAM,MAAM,GACZ,MAAQ,MAEZ,UAAY,KACZ,SAAW,KACX,SAAS,cAAc,CAAC,cAAc,WAAW,CAAG,MACpD,SAAS,cAAc,CAAC,YAAY,WAAW,CAAG,KAGlD,IAAM,EAAuB,SAAS,cAAc,CAAC,kBACjD,IACA,EAAqB,WAAW,CAAG,MACnC,EAAqB,KAAK,CAAC,KAAK,CAAG,QAIvC,qBACA,eAAe,YACnB,GAGA,SAAS,cAAc,CAAC,YAAY,gBAAgB,CAAC,QAAS,WACtD,MACI,MAAM,OAAO,IACb,MAAM,KAAK,GACX,IAAI,CAAC,WAAW,CAAG,OAEnB,MAAM,IAAI,GACV,IAAI,CAAC,WAAW,CAAG,MAGvB,eAAe,cAEvB,GAGA,SAAS,cAAc,CAAC,UAAU,gBAAgB,CAAC,QAAS,WACxD,IAAM,EAAS,WAAW,IAAI,CAAC,KAAK,CAChC,CAAA,OACA,MAAM,MAAM,CAAC,EAErB,EACJ,CAGA,SAAS,gBACL,IAAM,EAAgB,SAAS,aAAa,CAAC,mBAGvC,EAAS,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,IAAK,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAK,AAGpG,CAAA,OACA,MAAM,EAAE,CAAC,cAAe,WAEhB,KAAK,MAAM,GAAK,IAChB,gBAAgB,EAAe,EAEvC,EAER,CAGA,SAAS,gBAAgB,CAAS,CAAE,CAAM,EAGtC,GAAI,AADmB,EAAU,gBAAgB,CAAC,eAC/B,MAAM,CAAG,GAAI,OAGhC,IAAM,EAAa,KAAK,KAAK,CAAC,AAAgB,EAAhB,KAAK,MAAM,IAAU,EAEnD,IAAK,IAAI,EAAI,EAAG,EAAI,EAAY,IAAK,CACjC,IAAM,EAAQ,SAAS,aAAa,CAAC,MACrC,CAAA,EAAM,SAAS,CAAG,aAClB,EAAM,WAAW,CAAG,CAAM,CAAC,KAAK,KAAK,CAAC,KAAK,MAAM,GAAK,EAAO,MAAM,EAAE,CAGrE,IAAM,EAAO,AAAgB,IAAhB,KAAK,MAAM,GAClB,EAAW,AAAgB,GAAhB,KAAK,MAAM,GAAU,GAChC,EAAW,AAAgB,EAAhB,KAAK,MAAM,GAAS,CAErC,CAAA,EAAM,KAAK,CAAC,QAAQ,CAAG,WACvB,EAAM,KAAK,CAAC,IAAI,CAAG,CAAA,EAAG,EAAK,CAAC,CAAC,CAC7B,EAAM,KAAK,CAAC,GAAG,CAAG,QAClB,EAAM,KAAK,CAAC,QAAQ,CAAG,CAAA,EAAG,EAAS,EAAE,CAAC,CACtC,EAAM,KAAK,CAAC,aAAa,CAAG,OAC5B,EAAM,KAAK,CAAC,MAAM,CAAG,KACrB,EAAM,KAAK,CAAC,SAAS,CAAG,CAAC,UAAU,EAAE,EAAS,sBAAsB,CAAC,CAErE,EAAU,WAAW,CAAC,GAGtB,WAAW,KACP,EAAM,MAAM,EAChB,EAAG,AAAW,IAAX,EACP,CACJ,CAGA,OAAO,MAAM,CAAG","sources":["<anon>","js/edit.js"],"sourcesContent":["// 全局变量\nlet gifts = [];\nlet currentGiftIndex = -1;\nlet quill = null;\nlet audio = null;\nlet audioFile = null;\nlet audioUrl = null;\nlet cropper = null;\nlet currentFile = null;\nlet editId = null; // 编辑状态ID\n// 服务器配置\n// 服务器地址\nconst SERVER_URL = 'http://localhost:3000';\n// 从localStorage加载数据\nfunction loadFromLocalStorage() {\n    const savedData = localStorage.getItem('giftLetterData');\n    if (savedData) try {\n        const data = JSON.parse(savedData);\n        gifts = data.gifts || [];\n        audioUrl = data.audioUrl || null;\n        // 更新音乐播放器UI状态\n        if (audioUrl) {\n            // 优先使用保存的原始文件名\n            const fileName = data.audioName || (()=>{\n                // 从URL中提取文件名作为备用\n                const urlParts = audioUrl.split('/');\n                return urlParts[urlParts.length - 1];\n            })();\n            document.getElementById('music-info').textContent = fileName;\n            // 更新音乐文件名显示元素\n            const musicFilenameElement = document.getElementById('music-filename');\n            if (musicFilenameElement) {\n                musicFilenameElement.textContent = fileName;\n                musicFilenameElement.style.color = '#666';\n            }\n            // 创建Howl实例\n            if (audio) audio.unload();\n            audio = new Howl({\n                src: [\n                    audioUrl\n                ],\n                loop: true,\n                volume: parseFloat(document.getElementById('volume').value)\n            });\n        } else {\n            document.getElementById('music-info').textContent = \"\\u672A\\u9009\\u62E9\";\n            // 清空音乐文件名显示元素\n            const musicFilenameElement = document.getElementById('music-filename');\n            if (musicFilenameElement) {\n                musicFilenameElement.textContent = \"\\u672A\\u9009\\u62E9\";\n                musicFilenameElement.style.color = '#666';\n            }\n        }\n        // 恢复主题色\n        if (data.theme) {\n            document.body.classList.remove('pink', 'white', 'blue');\n            document.body.classList.add(data.theme);\n            // 更新颜色按钮状态\n            const colorBtns = document.querySelectorAll('.color-btn');\n            colorBtns.forEach((btn)=>{\n                if (btn.dataset.color === data.theme) btn.classList.add('active');\n                else btn.classList.remove('active');\n            });\n        }\n        // 恢复标题\n        if (data.siteTitle) document.getElementById('site-title').value = data.siteTitle;\n        if (data.letterTitle) document.getElementById('letter-title').value = data.letterTitle;\n        // 恢复书信内容\n        if (data.letterContent && quill) quill.root.innerHTML = data.letterContent;\n        // 恢复礼物列表\n        renderGifts();\n    } catch (error) {\n        console.error(\"\\u52A0\\u8F7D\\u6570\\u636E\\u5931\\u8D25:\", error);\n    }\n}\n// 保存数据到localStorage\nfunction saveToLocalStorage() {\n    // 获取当前主题色\n    const currentTheme = document.body.classList.contains('pink') ? 'pink' : document.body.classList.contains('white') ? 'white' : 'blue';\n    const data = {\n        gifts: gifts,\n        audioUrl: audioUrl,\n        audioName: audioFile ? audioFile.name : null,\n        siteTitle: document.getElementById('site-title').value,\n        letterTitle: document.getElementById('letter-title').value,\n        letterContent: quill ? quill.root.innerHTML : '',\n        theme: currentTheme\n    };\n    localStorage.setItem('giftLetterData', JSON.stringify(data));\n    console.log(\"\\u6570\\u636E\\u5DF2\\u4FDD\\u5B58\\u5230\\u672C\\u5730\\u5B58\\u50A8\");\n}\n// 保存编辑状态到后端\nasync function saveEditState() {\n    try {\n        // 获取当前主题色\n        const currentTheme = document.body.classList.contains('pink') ? 'pink' : document.body.classList.contains('white') ? 'white' : 'blue';\n        const data = {\n            editId: editId,\n            gifts: gifts,\n            audioUrl: audioUrl,\n            audioName: audioFile ? audioFile.name : null,\n            siteTitle: document.getElementById('site-title').value,\n            letterTitle: document.getElementById('letter-title').value,\n            letterContent: quill ? quill.root.innerHTML : '',\n            theme: currentTheme\n        };\n        const response = await fetch(`${SERVER_URL}/api/save-edit`, {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json'\n            },\n            body: JSON.stringify(data)\n        });\n        const result = await response.json();\n        if (result.success) {\n            editId = result.editId;\n            console.log(\"\\u7F16\\u8F91\\u72B6\\u6001\\u5DF2\\u4FDD\\u5B58\\u5230\\u540E\\u7AEF\");\n            showSaveStatus(\"\\uD83D\\uDCBE \\u7F16\\u8F91\\u72B6\\u6001\\u4FDD\\u5B58\\u6210\\u529F\\u5566\\uFF5E\");\n            // 更新当前编辑ID显示\n            updateCurrentEditId();\n            return result.editId;\n        }\n    } catch (error) {\n        console.error(\"\\u4FDD\\u5B58\\u7F16\\u8F91\\u72B6\\u6001\\u5931\\u8D25:\", error);\n    }\n    return null;\n}\n// 显示保存状态\nfunction showSaveStatus(message) {\n    // 创建或获取保存状态元素\n    let saveStatus = document.getElementById('save-status');\n    if (!saveStatus) {\n        saveStatus = document.createElement('div');\n        saveStatus.id = 'save-status';\n        saveStatus.style.cssText = `\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            color: white;\n            padding: 12px 20px;\n            border-radius: 5px;\n            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);\n            z-index: 1000;\n            transition: all 0.3s ease;\n            opacity: 0;\n            transform: translateY(-20px);\n        `;\n        document.body.appendChild(saveStatus);\n    }\n    // 设置消息并显示\n    saveStatus.textContent = message;\n    saveStatus.style.opacity = '1';\n    saveStatus.style.transform = 'translateY(0)';\n    // 3秒后隐藏\n    setTimeout(()=>{\n        saveStatus.style.opacity = '0';\n        saveStatus.style.transform = 'translateY(-20px)';\n    }, 3000);\n}\n// 从后端加载编辑状态\nasync function loadEditState(loadEditId) {\n    try {\n        const response = await fetch(`${SERVER_URL}/api/load-edit?editId=${loadEditId}`);\n        const result = await response.json();\n        if (result.success) {\n            const data = result.data;\n            editId = data.editId;\n            gifts = data.gifts || [];\n            audioUrl = data.audioUrl || null;\n            // 更新音乐播放器UI状态\n            if (audioUrl) {\n                // 优先使用保存的原始文件名\n                const fileName = data.audioName || (()=>{\n                    // 从URL中提取文件名作为备用\n                    const urlParts = audioUrl.split('/');\n                    return urlParts[urlParts.length - 1];\n                })();\n                document.getElementById('music-info').textContent = fileName;\n                // 更新音乐文件名显示元素\n                const musicFilenameElement = document.getElementById('music-filename');\n                if (musicFilenameElement) {\n                    musicFilenameElement.textContent = fileName;\n                    musicFilenameElement.style.color = '#666';\n                }\n                // 创建Howl实例\n                if (audio) audio.unload();\n                audio = new Howl({\n                    src: [\n                        audioUrl\n                    ],\n                    loop: true,\n                    volume: parseFloat(document.getElementById('volume').value)\n                });\n            } else {\n                document.getElementById('music-info').textContent = \"\\u672A\\u9009\\u62E9\";\n                // 清空音乐文件名显示元素\n                const musicFilenameElement = document.getElementById('music-filename');\n                if (musicFilenameElement) {\n                    musicFilenameElement.textContent = \"\\u672A\\u9009\\u62E9\";\n                    musicFilenameElement.style.color = '#666';\n                }\n            }\n            // 恢复主题色\n            if (data.theme) {\n                document.body.classList.remove('pink', 'white', 'blue');\n                document.body.classList.add(data.theme);\n                // 更新颜色按钮状态\n                const colorBtns = document.querySelectorAll('.color-btn');\n                colorBtns.forEach((btn)=>{\n                    if (btn.dataset.color === data.theme) btn.classList.add('active');\n                    else btn.classList.remove('active');\n                });\n            }\n            // 恢复标题\n            if (data.siteTitle) document.getElementById('site-title').value = data.siteTitle;\n            if (data.letterTitle) document.getElementById('letter-title').value = data.letterTitle;\n            // 恢复书信内容\n            if (data.letterContent && quill) quill.root.innerHTML = data.letterContent;\n            // 恢复礼物列表\n            renderGifts();\n            showSaveStatus(\"\\uD83D\\uDD04 \\u7F16\\u8F91\\u72B6\\u6001\\u6062\\u590D\\u6210\\u529F\\u5566\\uFF5E\");\n            return true;\n        }\n    } catch (error) {\n        console.error(\"\\u52A0\\u8F7D\\u7F16\\u8F91\\u72B6\\u6001\\u5931\\u8D25:\", error);\n        showSaveStatus(\"\\u52A0\\u8F7D\\u7F16\\u8F91\\u72B6\\u6001\\u5931\\u8D25\");\n    }\n    return false;\n}\n// 上传文件到服务器\nfunction uploadFileToServer(file) {\n    return new Promise((resolve, reject)=>{\n        const formData = new FormData();\n        formData.append('file', file);\n        fetch(`${SERVER_URL}/api/upload`, {\n            method: 'POST',\n            body: formData\n        }).then((response)=>{\n            if (!response.ok) throw new Error('Upload failed');\n            return response.json();\n        }).then((data)=>{\n            if (data.error) reject(data.error);\n            else resolve(data.url);\n        }).catch((error)=>{\n            console.error('Upload error:', error);\n            reject(error);\n        });\n    });\n}\n// 初始化字体选择器\nfunction initFontSelector() {\n    const fontSelect = document.getElementById('font-select');\n    const fontPreview = document.getElementById('font-preview');\n    if (fontSelect && fontPreview) {\n        // 字体选择事件\n        fontSelect.addEventListener('change', function() {\n            const selectedFont = this.value;\n            // 更新预览区域字体\n            fontPreview.style.fontFamily = selectedFont;\n            // 更新页面全局字体\n            document.body.style.fontFamily = selectedFont;\n            // 更新Quill编辑器字体\n            if (quill) {\n                const editor = document.querySelector('.ql-editor');\n                if (editor) editor.style.fontFamily = selectedFont;\n            }\n            // 更新礼物备注字体\n            const giftNotes = document.querySelectorAll('.gift-note');\n            giftNotes.forEach((note)=>{\n                note.style.fontFamily = selectedFont;\n            });\n            console.log(\"\\u5B57\\u4F53\\u5DF2\\u66F4\\u65B0\\u4E3A:\", selectedFont);\n        });\n        // 初始化预览字体\n        fontPreview.style.fontFamily = fontSelect.value;\n    }\n}\n// 初始化页面\nfunction initPage() {\n    initQuill();\n    initColorPicker();\n    initGiftManagement();\n    initMusicPlayer();\n    initGenerateButtons();\n    initModals();\n    initSortable();\n    initFontSelector();\n    // 清理可能存在的事件监听器\n    const giftGrid = document.getElementById('gift-grid');\n    giftGrid.innerHTML = giftGrid.innerHTML;\n    // 检查URL参数中是否有editId\n    const urlParams = new URLSearchParams(window.location.search);\n    const urlEditId = urlParams.get('editId');\n    if (urlEditId) // 延迟加载编辑状态，确保页面元素已初始化\n    setTimeout(()=>{\n        loadEditState(urlEditId);\n    }, 500);\n    else // 从localStorage加载数据\n    loadFromLocalStorage();\n    // 初始化表情掉落动画\n    initEmojiRain();\n}\n// 初始化富文本编辑器\nfunction initQuill() {\n    quill = new Quill('#letter-content', {\n        theme: 'snow',\n        modules: {\n            toolbar: [\n                [\n                    'bold',\n                    'italic',\n                    'underline'\n                ],\n                [\n                    'blockquote',\n                    'code-block'\n                ],\n                [\n                    {\n                        'header': 1\n                    },\n                    {\n                        'header': 2\n                    }\n                ],\n                [\n                    {\n                        'list': 'ordered'\n                    },\n                    {\n                        'list': 'bullet'\n                    }\n                ],\n                [\n                    {\n                        'color': []\n                    },\n                    {\n                        'background': []\n                    }\n                ],\n                [\n                    {\n                        'align': []\n                    }\n                ],\n                [\n                    'clean'\n                ]\n            ]\n        },\n        placeholder: \"\\u8BF7\\u8F93\\u5165\\u4E66\\u4FE1\\u5185\\u5BB9...\",\n        // 设置默认字体\n        formats: [\n            'font',\n            'size',\n            'bold',\n            'italic',\n            'underline',\n            'strike',\n            'blockquote',\n            'code-block',\n            'header',\n            'list',\n            'bullet',\n            'indent',\n            'link',\n            'image',\n            'color',\n            'background',\n            'align'\n        ],\n        defaultFont: 'Comic Neue'\n    });\n    // 确保编辑器内容使用可爱字体\n    quill.on('editor-change', function() {\n        const editor = document.querySelector('.ql-editor');\n        if (editor) {\n            editor.style.fontFamily = \"'Comic Neue', 'Nunito', 'Microsoft YaHei', Arial, sans-serif\";\n            editor.style.fontSize = '18px';\n        }\n    });\n}\n// 初始化颜色选择器\nfunction initColorPicker() {\n    const colorBtns = document.querySelectorAll('.color-btn');\n    colorBtns.forEach((btn)=>{\n        btn.addEventListener('click', ()=>{\n            // 移除所有按钮的active类\n            colorBtns.forEach((b)=>b.classList.remove('active'));\n            // 添加当前按钮的active类\n            btn.classList.add('active');\n            // 更改body的颜色类\n            const color = btn.dataset.color;\n            document.body.className = color;\n        });\n    });\n}\n// 初始化礼物管理\nfunction initGiftManagement() {\n    // 添加礼物按钮\n    document.getElementById('add-gift').addEventListener('click', ()=>{\n        currentGiftIndex = -1;\n        openGiftModal();\n    });\n}\n// 打开礼物编辑弹窗\nfunction openGiftModal() {\n    document.getElementById('gift-modal').style.display = 'block';\n    // 重置文件输入\n    document.getElementById('gift-file').value = '';\n    // 如果是添加新礼物，清空备注并隐藏媒体预览\n    if (currentGiftIndex === -1) {\n        document.getElementById('gift-note').value = '';\n        const currentMediaPreview = document.getElementById('current-media-preview');\n        const mediaPreviewContent = document.getElementById('media-preview-content');\n        currentMediaPreview.style.display = 'none';\n        mediaPreviewContent.innerHTML = '';\n    }\n}\n// 关闭礼物编辑弹窗\nfunction closeGiftModal() {\n    document.getElementById('gift-modal').style.display = 'none';\n}\n// 处理文件选择，添加裁剪步骤\nfunction handleFileSelect(e) {\n    const file = e.target.files[0];\n    if (!file) return;\n    currentFile = file;\n    if (file.type.startsWith('image/')) // 图片需要裁剪\n    openCropModal(file);\n    else // 视频直接上传\n    saveGiftWithFile(file);\n}\n// 打开裁剪弹窗\nfunction openCropModal(file) {\n    const reader = new FileReader();\n    reader.onload = function(e) {\n        const img = document.getElementById('crop-image');\n        img.src = e.target.result;\n        // 初始化裁剪器\n        if (cropper) cropper.destroy();\n        cropper = new Cropper(img, {\n            aspectRatio: 1,\n            viewMode: 1,\n            dragMode: 'move',\n            autoCropArea: 0.8,\n            cropBoxMovable: true,\n            cropBoxResizable: true\n        });\n        // 显示裁剪弹窗\n        document.getElementById('crop-modal').style.display = 'block';\n    };\n    reader.readAsDataURL(file);\n}\n// 关闭裁剪弹窗\nfunction closeCropModal() {\n    if (cropper) {\n        cropper.destroy();\n        cropper = null;\n    }\n    document.getElementById('crop-modal').style.display = 'none';\n    currentFile = null;\n}\n// 全局变量：存储裁剪后的文件\nlet croppedFile = null;\n// 全局变量：跟踪添加礼物的状态\nlet isAddingGift = false;\n// 确认裁剪\nasync function confirmCrop() {\n    if (!cropper || isAddingGift) return;\n    try {\n        console.log(\"\\u5F00\\u59CB\\u88C1\\u526A\\u56FE\\u7247\");\n        // 设置添加礼物状态\n        isAddingGift = true;\n        // 获取裁剪后的图片\n        const canvas = cropper.getCroppedCanvas({\n            width: 800,\n            height: 800,\n            fillColor: '#fff',\n            imageSmoothingEnabled: true\n        });\n        // 将canvas转换为blob\n        canvas.toBlob(function(blob) {\n            console.log(\"\\u88C1\\u526A\\u5B8C\\u6210\\uFF0C\\u521B\\u5EFA\\u6587\\u4EF6\\u5BF9\\u8C61\");\n            // 创建新的File对象\n            croppedFile = new File([\n                blob\n            ], currentFile.name, {\n                type: currentFile.type,\n                lastModified: Date.now()\n            });\n            console.log(\"\\u5173\\u95ED\\u88C1\\u526A\\u5F39\\u7A97\");\n            // 关闭裁剪弹窗，返回礼物编辑弹窗\n            closeCropModal();\n            console.log(\"\\u663E\\u793A\\u63D0\\u793A\\u4FE1\\u606F\");\n            // 显示提示信息，让用户填写备注\n            alert(\"\\u2702\\uFE0F \\u88C1\\u526A\\u5B8C\\u6210\\u5566\\uFF5E\\u8BF7\\u586B\\u5199\\u793C\\u7269\\u5907\\u6CE8\\u540E\\u70B9\\u51FB\\u4FDD\\u5B58\\u54E6 \\uD83C\\uDF81\");\n            console.log(\"\\u88C1\\u526A\\u6D41\\u7A0B\\u5B8C\\u6210\\uFF0C\\u793C\\u7269\\u7F16\\u8F91\\u5F39\\u7A97\\u5E94\\u8BE5\\u4ECD\\u7136\\u6253\\u5F00\");\n            // 重置添加礼物状态\n            isAddingGift = false;\n        }, currentFile.type);\n    } catch (error) {\n        console.error(\"\\u88C1\\u526A\\u5931\\u8D25:\", error);\n        alert(\"\\uD83D\\uDE22 \\u88C1\\u526A\\u5931\\u8D25\\u4E86\\uFF5E\\u8BF7\\u518D\\u8BD5\\u4E00\\u6B21\\u5427 \\uD83D\\uDCAA\");\n        // 重置添加礼物状态\n        isAddingGift = false;\n    }\n}\n// 保存礼物（带文件参数）\nasync function saveGiftWithFile(file) {\n    if (isAddingGift) return;\n    const noteInput = document.getElementById('gift-note');\n    const note = noteInput.value;\n    try {\n        console.log(\"\\u5F00\\u59CB\\u4E0A\\u4F20\\u6587\\u4EF6:\", file.name);\n        // 设置添加礼物状态\n        isAddingGift = true;\n        // 上传文件到服务器\n        const url = await uploadFileToServer(file);\n        console.log(\"\\u6587\\u4EF6\\u4E0A\\u4F20\\u6210\\u529F\\uFF0CURL:\", url);\n        let gift;\n        if (currentGiftIndex === -1) {\n            // 添加新礼物\n            gift = {\n                id: Date.now(),\n                file: file,\n                url: url,\n                note: note,\n                type: file.type.startsWith('image/') ? 'image' : 'video'\n            };\n            gifts.push(gift);\n            console.log(\"\\u65B0\\u793C\\u7269\\u6DFB\\u52A0\\u6210\\u529F:\", gift.id);\n        } else {\n            // 编辑现有礼物，保留原始ID\n            gift = gifts[currentGiftIndex];\n            gift.file = file;\n            gift.url = url;\n            gift.note = note;\n            gift.type = file.type.startsWith('image/') ? 'image' : 'video';\n            // 保留原始ID\n            console.log(\"\\u793C\\u7269\\u7F16\\u8F91\\u6210\\u529F:\", gift.id);\n        }\n        // 重新渲染礼物列表\n        renderGifts();\n        // 关闭弹窗\n        closeGiftModal();\n        // 保存到本地存储\n        saveToLocalStorage();\n        // 显示保存成功提示\n        showSaveStatus(\"\\uD83C\\uDF89 \\u793C\\u7269\\u4FDD\\u5B58\\u6210\\u529F\\u5566\\uFF5E\");\n        console.log(\"\\u793C\\u7269\\u4FDD\\u5B58\\u5B8C\\u6210\");\n    } catch (error) {\n        console.error(\"\\u4FDD\\u5B58\\u793C\\u7269\\u5931\\u8D25:\", error);\n        console.error(\"\\u9519\\u8BEF\\u8BE6\\u60C5:\", error.message);\n        // 显示更详细的错误信息\n        alert(\"\\uD83D\\uDE22 \\u4E0A\\u4F20\\u5931\\u8D25\\u4E86\\uFF5E\\u8BF7\\u518D\\u8BD5\\u4E00\\u6B21\\u5427 \\uD83D\\uDCAA\\n\\n\\u9519\\u8BEF\\u4FE1\\u606F: \" + error.message);\n    } finally{\n        // 重置添加礼物状态\n        isAddingGift = false;\n        // 重置裁剪文件\n        croppedFile = null;\n    }\n}\n// 保存礼物\nfunction saveGift() {\n    if (isAddingGift) {\n        alert(\"\\u23F0 \\u793C\\u7269\\u6B63\\u5728\\u6DFB\\u52A0\\u4E2D\\uFF0C\\u8BF7\\u7A0D\\u5019\\u54E6\\uFF5E \\uD83C\\uDF80\");\n        return;\n    }\n    const fileInput = document.getElementById('gift-file');\n    const noteInput = document.getElementById('gift-note');\n    const note = noteInput.value;\n    console.log(\"\\u5F00\\u59CB\\u4FDD\\u5B58\\u793C\\u7269\");\n    console.log('currentGiftIndex:', currentGiftIndex);\n    console.log('fileInput.files.length:', fileInput.files.length);\n    console.log('croppedFile:', croppedFile);\n    console.log('note:', note);\n    // 如果是编辑现有礼物且没有选择新文件，只更新备注\n    if (currentGiftIndex !== -1 && !fileInput.files.length && !croppedFile) {\n        console.log(\"\\u7F16\\u8F91\\u73B0\\u6709\\u793C\\u7269\\uFF0C\\u53EA\\u66F4\\u65B0\\u5907\\u6CE8\");\n        const gift = gifts[currentGiftIndex];\n        // 更新备注\n        gift.note = note;\n        // 重新渲染礼物列表\n        renderGifts();\n        // 关闭弹窗\n        closeGiftModal();\n        // 保存到本地存储\n        saveToLocalStorage();\n        // 显示保存成功提示\n        showSaveStatus(\"\\uD83D\\uDCDD \\u793C\\u7269\\u5907\\u6CE8\\u66F4\\u65B0\\u6210\\u529F\\u5566\\uFF5E\");\n        return;\n    }\n    // 检查是否有裁剪后的文件\n    if (croppedFile) {\n        console.log(\"\\u4F7F\\u7528\\u88C1\\u526A\\u540E\\u7684\\u6587\\u4EF6\\u4FDD\\u5B58\\u793C\\u7269\");\n        // 使用裁剪后的文件\n        saveGiftWithFile(croppedFile);\n    } else if (fileInput.files.length) {\n        console.log(\"\\u5904\\u7406\\u7528\\u6237\\u9009\\u62E9\\u7684\\u6587\\u4EF6\");\n        // 处理文件选择\n        handleFileSelect({\n            target: fileInput\n        });\n    } else {\n        console.log(\"\\u6CA1\\u6709\\u9009\\u62E9\\u6587\\u4EF6\");\n        alert(\"\\uD83C\\uDF81 \\u8BF7\\u5148\\u9009\\u62E9\\u793C\\u7269\\u7D20\\u6750\\u54E6\\uFF5E\");\n        return;\n    }\n}\n// 渲染礼物列表\nfunction renderGifts() {\n    const giftGrid = document.getElementById('gift-grid');\n    giftGrid.innerHTML = '';\n    gifts.forEach((gift, index)=>{\n        const giftItem = document.createElement('div');\n        giftItem.className = 'gift-item';\n        let mediaElement = '';\n        if (gift.type === 'image') mediaElement = `<img src=\"${gift.url}\" alt=\"\\u{793C}\\u{7269}\\u{56FE}\\u{7247}\" class=\"gift-media\" onerror=\"this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22 viewBox=%220 0 200 200%22%3E%3Crect width=%22200%22 height=%22200%22 fill=%22%23f5f5f5%22/%3E%3Ctext x=%22100%22 y=%22100%22 font-family=%22Arial%22 font-size=%2216%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22%23999%22%3E\\u{56FE}\\u{7247}\\u{52A0}\\u{8F7D}\\u{5931}\\u{8D25}%3C/text%3E%3C/svg%3E'\">\n            <button onclick=\"previewImage(${index})\" class=\"preview-btn\">\\u{9884}\\u{89C8}</button>`;\n        else mediaElement = `<video src=\"${gift.url}\" class=\"gift-media\">\n            <button onclick=\"this.previousElementSibling.play()\" class=\"preview-btn\">\\u{64AD}\\u{653E}</button>`;\n        giftItem.innerHTML = `\n            <div class=\"gift-media-container\">\n                ${mediaElement}\n            </div>\n            <div class=\"gift-note\">${gift.note || \"\\u65E0\\u5907\\u6CE8\"}</div>\n            <div class=\"gift-actions\">\n                <button onclick=\"editGift(${index})\" class=\"edit-btn\">\\u{7F16}\\u{8F91}</button>\n                <button onclick=\"confirmAndDelete(${index})\" class=\"delete-btn\">\\u{5220}\\u{9664}</button>\n            </div>\n        `;\n        giftGrid.appendChild(giftItem);\n    });\n}\n// 添加一次性事件监听器\nfunction addSingleEventListeners() {\n    const giftGrid = document.getElementById('gift-grid');\n    // 点击媒体文件\n    giftGrid.addEventListener('click', function(e) {\n        if (e.target.tagName === 'IMG' || e.target.tagName === 'VIDEO') {\n            const giftItem = e.target.closest('.gift-item');\n            const deleteBtn = giftItem.querySelector('.delete-btn');\n            const index = parseInt(deleteBtn.dataset.index);\n            if (!isNaN(index)) {\n                if (e.target.tagName === 'IMG') previewImage(index);\n                else if (e.target.tagName === 'VIDEO') e.target.play();\n            }\n        }\n    });\n    // 点击编辑按钮\n    giftGrid.addEventListener('click', function(e) {\n        if (e.target.classList.contains('edit-btn')) {\n            e.stopPropagation();\n            const index = parseInt(e.target.dataset.index);\n            if (!isNaN(index)) editGift(index);\n        }\n    });\n}\n// 直接删除礼物\nfunction confirmAndDelete(index) {\n    console.log(\"\\u5220\\u9664\\u6309\\u94AE\\u88AB\\u70B9\\u51FB\\uFF0C\\u7D22\\u5F15:\", index);\n    console.log(\"\\u5F53\\u524Dgifts\\u6570\\u7EC4\\u957F\\u5EA6:\", gifts.length);\n    // 直接执行删除操作，不弹出确认框\n    if (index >= 0 && index < gifts.length) {\n        // 执行删除\n        gifts.splice(index, 1);\n        console.log(\"\\u5220\\u9664\\u540Egifts\\u6570\\u7EC4\\u957F\\u5EA6:\", gifts.length);\n        // 重新渲染\n        renderGifts();\n        // 保存到本地存储\n        saveToLocalStorage();\n        showSaveStatus(\"\\uD83D\\uDDD1\\uFE0F \\u793C\\u7269\\u5220\\u9664\\u6210\\u529F\\u5566\\uFF5E\");\n    } else {\n        console.error(\"\\u7D22\\u5F15\\u8D85\\u51FA\\u8303\\u56F4:\", index);\n        alert(\"\\uD83D\\uDE22 \\u5220\\u9664\\u5931\\u8D25\\u4E86\\uFF5E\\u7D22\\u5F15\\u8D85\\u51FA\\u8303\\u56F4\\u5566 \\uD83D\\uDCAA\");\n    }\n}\n// 编辑礼物\nfunction editGift(index) {\n    currentGiftIndex = index;\n    const gift = gifts[index];\n    document.getElementById('gift-note').value = gift.note;\n    // 显示当前媒体文件预览\n    const currentMediaPreview = document.getElementById('current-media-preview');\n    const mediaPreviewContent = document.getElementById('media-preview-content');\n    if (gift && gift.url) {\n        // 显示预览区域\n        currentMediaPreview.style.display = 'block';\n        // 根据礼物类型显示不同的预览\n        if (gift.type === 'image') mediaPreviewContent.innerHTML = `<img src=\"${gift.url}\" alt=\"\\u{793C}\\u{7269}\\u{56FE}\\u{7247}\" style=\"max-width: 100%; max-height: 200px; border-radius: 3px;\">`;\n        else if (gift.type === 'video') mediaPreviewContent.innerHTML = `<video src=\"${gift.url}\" style=\"max-width: 100%; max-height: 200px; border-radius: 3px;\" controls></video>`;\n    } else {\n        // 隐藏预览区域\n        currentMediaPreview.style.display = 'none';\n        mediaPreviewContent.innerHTML = '';\n    }\n    openGiftModal();\n}\n// 删除礼物\nfunction deleteGift(index) {\n    console.log(\"\\u5220\\u9664\\u6309\\u94AE\\u88AB\\u70B9\\u51FB\\uFF0C\\u7D22\\u5F15:\", index);\n    console.log(\"\\u5F53\\u524Dgifts\\u6570\\u7EC4\\u957F\\u5EA6:\", gifts.length);\n    console.log(\"\\u5F53\\u524Dgifts\\u6570\\u7EC4:\", gifts);\n    // 显示确认对话框\n    const confirmed = confirm(\"\\u786E\\u5B9A\\u8981\\u5220\\u9664\\u8FD9\\u4E2A\\u793C\\u7269\\u5417\\uFF1F\\u5220\\u9664\\u540E\\u65E0\\u6CD5\\u6062\\u590D\\u3002\");\n    console.log(\"\\u7528\\u6237\\u786E\\u8BA4:\", confirmed);\n    if (confirmed) {\n        console.log(\"\\u6267\\u884C\\u5220\\u9664\\u64CD\\u4F5C\\uFF0C\\u7D22\\u5F15:\", index);\n        if (index >= 0 && index < gifts.length) {\n            // 执行删除\n            gifts.splice(index, 1);\n            console.log(\"\\u5220\\u9664\\u540Egifts\\u6570\\u7EC4\\u957F\\u5EA6:\", gifts.length);\n            // 重新渲染\n            renderGifts();\n            // 保存到本地存储\n            saveToLocalStorage();\n            showSaveStatus(\"\\u793C\\u7269\\u5220\\u9664\\u6210\\u529F\");\n        } else {\n            console.error(\"\\u7D22\\u5F15\\u8D85\\u51FA\\u8303\\u56F4:\", index);\n            alert(\"\\u5220\\u9664\\u5931\\u8D25\\uFF1A\\u7D22\\u5F15\\u8D85\\u51FA\\u8303\\u56F4\");\n        }\n    } else console.log(\"\\u7528\\u6237\\u53D6\\u6D88\\u5220\\u9664\\u64CD\\u4F5C\");\n}\n// 预览图片\nfunction previewImage(index) {\n    const gift = gifts[index];\n    if (gift.type === 'image') // 这里可以实现图片预览功能\n    console.log(\"\\u9884\\u89C8\\u56FE\\u7247:\", gift.url);\n}\n// 初始化生成按钮\nfunction initGenerateButtons() {\n    // 预览按钮\n    document.getElementById('preview-btn').addEventListener('click', function() {\n        previewShowPage();\n    });\n    // 生成按钮\n    document.getElementById('generate-btn').addEventListener('click', function() {\n        generateShowPackage();\n    });\n}\n// 预览展示页\nfunction previewShowPage() {\n    const previewContent = document.getElementById('preview-content');\n    const siteTitle = document.getElementById('site-title').value;\n    const letterTitle = document.getElementById('letter-title').value;\n    const letterContent = quill.root.innerHTML;\n    // 构建预览内容\n    let html = `\n        <h1>${siteTitle}</h1>\n        <h2>\\u{793C}\\u{7269}</h2>\n        <div class=\"gift-grid\">\n    `;\n    gifts.forEach((gift)=>{\n        let mediaElement = '';\n        if (gift.type === 'image') mediaElement = `<img src=\"${gift.url}\" alt=\"\\u{793C}\\u{7269}\\u{56FE}\\u{7247}\" class=\"gift-media\">`;\n        else mediaElement = `<video src=\"${gift.url}\" class=\"gift-media\"></video>`;\n        html += `\n            <div class=\"gift-item\">\n                <div class=\"gift-media-container\">\n                    ${mediaElement}\n                </div>\n                <div class=\"gift-note\">${gift.note || \"\\u65E0\\u5907\\u6CE8\"}</div>\n            </div>\n        `;\n    });\n    html += `\n        </div>\n        <h2>${letterTitle}</h2>\n        <div class=\"letter-content\">${letterContent}</div>\n        <div class=\"music-player\">\n            <span>\\u{80CC}\\u{666F}\\u{97F3}\\u{4E50}: ${audioFile ? audioFile.name : \"\\u672A\\u9009\\u62E9\"}</span>\n        </div>\n    `;\n    previewContent.innerHTML = html;\n    document.getElementById('preview-modal').style.display = 'block';\n}\n// 生成展示包\nasync function generateShowPackage() {\n    try {\n        // 保存编辑状态\n        await saveEditState();\n        const siteTitle = document.getElementById('site-title').value || \"\\u6211\\u7684\\u793C\\u7269\";\n        const letterTitle = document.getElementById('letter-title').value || \"\\u751F\\u65E5\\u795D\\u798F\";\n        const letterContent = quill.root.innerHTML;\n        // 获取当前主题色\n        const currentTheme = document.body.classList.contains('pink') ? 'pink' : document.body.classList.contains('white') ? 'white' : 'blue';\n        // 准备展示数据\n        const showData = {\n            siteTitle: siteTitle,\n            letterTitle: letterTitle,\n            letterContent: letterContent,\n            gifts: gifts.map((gift)=>({\n                    id: gift.id,\n                    url: gift.url,\n                    note: gift.note,\n                    type: gift.type\n                })),\n            audioUrl: audioUrl,\n            audioName: audioFile ? audioFile.name : null,\n            theme: currentTheme\n        };\n        // 保存到后端并获取分享链接\n        const response = await fetch(`${SERVER_URL}/api/save-show`, {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json'\n            },\n            body: JSON.stringify(showData)\n        });\n        const result = await response.json();\n        if (result.success) {\n            // 显示生成成功信息和分享链接\n            let editLink = '';\n            if (editId) editLink = `<p style=\"margin-top: 10px;\">\\u{7F16}\\u{8F91}\\u{94FE}\\u{63A5}\\u{FF08}\\u{7528}\\u{4E8E}\\u{540E}\\u{7EED}\\u{4FEE}\\u{6539}\\u{FF09}\\u{FF1A}</p>\n                <p style=\"background-color: #f0f0f0; padding: 15px; border-radius: 5px; word-break: break-all;\">\n                    ${SERVER_URL}/edit.html?editId=${editId}\n                </p>`;\n            document.getElementById('generate-info').innerHTML = `\n                <p style=\"color: green;\">\\u{751F}\\u{6210}\\u{6210}\\u{529F}\\u{FF01}\\u{8BF7}\\u{5C06}\\u{4EE5}\\u{4E0B}\\u{94FE}\\u{63A5}\\u{5206}\\u{4EAB}\\u{7ED9}\\u{5BF9}\\u{65B9}\\u{FF1A}</p>\n                <p style=\"background-color: #f0f0f0; padding: 15px; border-radius: 5px; word-break: break-all;\">\n                    ${result.shareUrl}\n                </p>\n                ${editLink}\n                <p style=\"color: blue;\">\\u{6CE8}\\u{610F}\\u{FF1A}\\u{6B64}\\u{94FE}\\u{63A5}\\u{6C38}\\u{4E45}\\u{6709}\\u{6548}\\u{FF0C}\\u{8BF7}\\u{59A5}\\u{5584}\\u{4FDD}\\u{7BA1}\\u{3002}</p>\n            `;\n            // 复制链接到剪贴板\n            try {\n                await navigator.clipboard.writeText(result.shareUrl);\n                document.getElementById('generate-info').innerHTML += `\n                    <p style=\"color: green; font-size: 14px;\">\\u{2705} \\u{5206}\\u{4EAB}\\u{94FE}\\u{63A5}\\u{5DF2}\\u{590D}\\u{5236}\\u{5230}\\u{526A}\\u{8D34}\\u{677F}</p>\n                `;\n            } catch (clipboardError) {\n                console.log(\"\\u65E0\\u6CD5\\u590D\\u5236\\u5230\\u526A\\u8D34\\u677F:\", clipboardError);\n            }\n        } else document.getElementById('generate-info').innerHTML = `\n                <p style=\"color: red;\">\\u{751F}\\u{6210}\\u{5931}\\u{8D25}: ${result.error}</p>\n            `;\n    } catch (error) {\n        console.error(\"\\u751F\\u6210\\u5206\\u4EAB\\u94FE\\u63A5\\u5931\\u8D25:\", error);\n        document.getElementById('generate-info').innerHTML = `\n            <p style=\"color: red;\">\\u{751F}\\u{6210}\\u{5931}\\u{8D25}\\u{FF0C}\\u{8BF7}\\u{91CD}\\u{8BD5}\\u{3002}</p>\n        `;\n    }\n}\n// 更新当前编辑ID显示\nfunction updateCurrentEditId() {\n    const currentEditIdElement = document.getElementById('current-edit-id');\n    if (currentEditIdElement) {\n        if (editId) currentEditIdElement.textContent = `\\u{5F53}\\u{524D}\\u{7F16}\\u{8F91}ID: ${editId} (\\u{53EF}\\u{7528}\\u{4E8E}\\u{540E}\\u{7EED}\\u{6062}\\u{590D}\\u{7F16}\\u{8F91})`;\n        else currentEditIdElement.textContent = \"\\u672A\\u4FDD\\u5B58\\u7F16\\u8F91\\u72B6\\u6001\";\n    }\n}\n// 初始化弹窗\nfunction initModals() {\n    // 关闭礼物弹窗\n    document.querySelector('#gift-modal .close').addEventListener('click', closeGiftModal);\n    // 关闭预览弹窗\n    document.querySelector('#preview-modal .close').addEventListener('click', function() {\n        document.getElementById('preview-modal').style.display = 'none';\n    });\n    // 关闭裁剪弹窗\n    document.querySelector('#crop-modal .close').addEventListener('click', closeCropModal);\n    document.getElementById('cancel-crop').addEventListener('click', closeCropModal);\n    document.getElementById('confirm-crop').addEventListener('click', confirmCrop);\n    // 点击弹窗外部关闭\n    window.addEventListener('click', function(e) {\n        const giftModal = document.getElementById('gift-modal');\n        const previewModal = document.getElementById('preview-modal');\n        const cropModal = document.getElementById('crop-modal');\n        if (e.target === giftModal) closeGiftModal();\n        if (e.target === previewModal) previewModal.style.display = 'none';\n        if (e.target === cropModal) closeCropModal();\n    });\n    // 保存礼物按钮\n    document.getElementById('save-gift').addEventListener('click', saveGift);\n    // 文件选择事件\n    document.getElementById('gift-file').addEventListener('change', handleFileSelect);\n    // 标题和内容变化时自动保存\n    document.getElementById('site-title').addEventListener('input', saveToLocalStorage);\n    document.getElementById('letter-title').addEventListener('input', saveToLocalStorage);\n    // 延迟添加Quill监听，确保Quill已初始化\n    setTimeout(()=>{\n        if (quill) {\n            quill.on('text-change', saveToLocalStorage);\n            console.log(\"\\u5DF2\\u6DFB\\u52A0Quill\\u6587\\u672C\\u53D8\\u5316\\u76D1\\u542C\");\n        }\n    }, 500);\n    // 恢复编辑状态按钮\n    const loadEditBtn = document.getElementById('load-edit-btn');\n    if (loadEditBtn) loadEditBtn.addEventListener('click', function() {\n        const editIdInput = document.getElementById('edit-id-input');\n        const inputEditId = editIdInput.value.trim();\n        if (inputEditId) loadEditState(inputEditId);\n        else alert(\"\\u8BF7\\u8F93\\u5165\\u7F16\\u8F91ID\");\n    });\n}\n// 初始化拖拽排序\nfunction initSortable() {\n    const giftGrid = document.getElementById('gift-grid');\n    new Sortable(giftGrid, {\n        animation: 150,\n        ghostClass: 'sortable-ghost',\n        chosenClass: 'sortable-chosen',\n        dragClass: 'sortable-drag',\n        onStart: function(evt) {\n            // 排序开始时的视觉反馈\n            const draggedElement = evt.item;\n            draggedElement.style.opacity = '0.5';\n        },\n        onEnd: function(evt) {\n            // 排序结束时的视觉反馈\n            const draggedElement = evt.item;\n            draggedElement.style.opacity = '1';\n            // 重新排序礼物数组\n            const draggedGift = gifts.splice(evt.oldIndex, 1)[0];\n            gifts.splice(evt.newIndex, 0, draggedGift);\n            // 重新渲染礼物列表，确保删除按钮的index值与当前gifts数组顺序一致\n            renderGifts();\n            // 保存到本地存储\n            saveToLocalStorage();\n            showSaveStatus(\"\\u793C\\u7269\\u987A\\u5E8F\\u5DF2\\u66F4\\u65B0\");\n        }\n    });\n}\n// 初始化音乐播放器\nfunction initMusicPlayer() {\n    // 音乐上传按钮点击事件\n    document.getElementById('music-upload-btn').addEventListener('click', function() {\n        document.getElementById('music-upload').click();\n    });\n    // 音乐上传\n    document.getElementById('music-upload').addEventListener('change', async function(e) {\n        const file = e.target.files[0];\n        if (file && file.type.startsWith('audio/')) try {\n            // 先更新音乐信息，显示正在上传\n            document.getElementById('music-info').textContent = \"\\u4E0A\\u4F20\\u4E2D...\";\n            // 上传文件到服务器\n            const url = await uploadFileToServer(file);\n            // 替换音乐\n            if (audio) {\n                audio.unload();\n                showSaveStatus(\"\\uD83C\\uDFB5 \\u97F3\\u4E50\\u5DF2\\u66FF\\u6362\\uFF5E\");\n            } else showSaveStatus(\"\\uD83C\\uDFB5 \\u97F3\\u4E50\\u4FDD\\u5B58\\u6210\\u529F\\u5566\\uFF5E\");\n            audioFile = file;\n            audioUrl = url;\n            document.getElementById('music-info').textContent = file.name;\n            // 更新音乐文件名显示元素\n            const musicFilenameElement = document.getElementById('music-filename');\n            if (musicFilenameElement) {\n                musicFilenameElement.textContent = file.name;\n                musicFilenameElement.style.color = '#666';\n            }\n            // 创建新的Howl实例\n            audio = new Howl({\n                src: [\n                    url\n                ],\n                loop: true,\n                volume: parseFloat(document.getElementById('volume').value)\n            });\n            // 保存到本地存储\n            saveToLocalStorage();\n        } catch (error) {\n            console.error(\"\\u4E0A\\u4F20\\u97F3\\u4E50\\u5931\\u8D25:\", error);\n            document.getElementById('music-info').textContent = \"\\u4E0A\\u4F20\\u5931\\u8D25\";\n            alert(\"\\uD83D\\uDE22 \\u97F3\\u4E50\\u4E0A\\u4F20\\u5931\\u8D25\\u4E86\\uFF5E\\u8BF7\\u518D\\u8BD5\\u4E00\\u6B21\\u5427 \\uD83D\\uDCAA\");\n        }\n        else if (file) alert(\"\\uD83C\\uDFB5 \\u8BF7\\u9009\\u62E9\\u97F3\\u9891\\u6587\\u4EF6\\u54E6\\uFF5E\");\n    });\n    // 清除音乐\n    document.getElementById('clear-music').addEventListener('click', function() {\n        if (audio) {\n            audio.unload();\n            audio = null;\n        }\n        audioFile = null;\n        audioUrl = null;\n        document.getElementById('music-info').textContent = \"\\u672A\\u9009\\u62E9\";\n        document.getElementById('play-btn').textContent = \"\\u64AD\\u653E\";\n        // 清空音乐文件名显示元素\n        const musicFilenameElement = document.getElementById('music-filename');\n        if (musicFilenameElement) {\n            musicFilenameElement.textContent = \"\\u672A\\u9009\\u62E9\";\n            musicFilenameElement.style.color = '#666';\n        }\n        // 保存到本地存储\n        saveToLocalStorage();\n        showSaveStatus(\"\\uD83C\\uDFB5 \\u97F3\\u4E50\\u5DF2\\u6E05\\u9664\\uFF5E\");\n    });\n    // 播放/暂停按钮\n    document.getElementById('play-btn').addEventListener('click', function() {\n        if (audio) {\n            if (audio.playing()) {\n                audio.pause();\n                this.textContent = \"\\u64AD\\u653E\";\n            } else {\n                audio.play();\n                this.textContent = \"\\u6682\\u505C\";\n            }\n        } else showSaveStatus(\"\\uD83C\\uDFB5 \\u8BF7\\u5148\\u9009\\u62E9\\u97F3\\u4E50\\u54E6\\uFF5E\");\n    });\n    // 音量控制\n    document.getElementById('volume').addEventListener('input', function() {\n        const volume = parseFloat(this.value);\n        if (audio) audio.volume(volume);\n    });\n}\n// 初始化表情掉落动画\nfunction initEmojiRain() {\n    const letterContent = document.querySelector('.letter-content');\n    // 可爱表情集合\n    const emojis = [\n        \"\\uD83D\\uDE0A\",\n        \"\\uD83E\\uDD70\",\n        \"\\uD83E\\uDD29\",\n        \"\\uD83C\\uDF1F\",\n        \"\\uD83C\\uDF80\",\n        \"\\uD83C\\uDF89\",\n        \"\\u2728\",\n        \"\\uD83D\\uDC96\",\n        \"\\uD83C\\uDF38\",\n        \"\\uD83E\\uDD8B\",\n        \"\\uD83C\\uDF08\",\n        \"\\uD83D\\uDC9D\",\n        \"\\uD83D\\uDC97\",\n        \"\\uD83D\\uDC93\",\n        \"\\uD83D\\uDC9E\"\n    ];\n    // 当用户输入时触发表情掉落\n    if (quill) quill.on('text-change', function() {\n        // 随机决定是否触发，避免过于频繁\n        if (Math.random() > 0.7) createEmojiRain(letterContent, emojis);\n    });\n}\n// 创建表情掉落效果\nfunction createEmojiRain(container, emojis) {\n    // 限制同时显示的表情数量\n    const existingEmojis = container.querySelectorAll('.emoji-rain');\n    if (existingEmojis.length > 10) return;\n    // 创建多个表情\n    const emojiCount = Math.floor(Math.random() * 3) + 1;\n    for(let i = 0; i < emojiCount; i++){\n        const emoji = document.createElement('div');\n        emoji.className = 'emoji-rain';\n        emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];\n        // 随机位置和样式\n        const left = Math.random() * 100;\n        const fontSize = Math.random() * 20 + 20;\n        const duration = Math.random() * 3 + 2;\n        emoji.style.position = 'absolute';\n        emoji.style.left = `${left}%`;\n        emoji.style.top = '-30px';\n        emoji.style.fontSize = `${fontSize}px`;\n        emoji.style.pointerEvents = 'none';\n        emoji.style.zIndex = '10';\n        emoji.style.animation = `emojiFall ${duration}s ease-in-out forwards`;\n        container.appendChild(emoji);\n        // 动画结束后移除\n        setTimeout(()=>{\n            emoji.remove();\n        }, duration * 1000);\n    }\n}\n// 页面加载完成后初始化\nwindow.onload = initPage;\n\n//# sourceMappingURL=edit.94cbf3ab.js.map\n","// 全局变量\r\nlet gifts = [];\r\nlet currentGiftIndex = -1;\r\nlet quill = null;\r\nlet audio = null;\r\nlet audioFile = null;\r\nlet audioUrl = null;\r\nlet cropper = null;\r\nlet currentFile = null;\r\nlet editId = null; // 编辑状态ID\r\n\r\n// 服务器配置\r\n// 服务器地址\r\nconst SERVER_URL = 'http://localhost:3000';\r\n\r\n// 从localStorage加载数据\r\nfunction loadFromLocalStorage() {\r\n    const savedData = localStorage.getItem('giftLetterData');\r\n    if (savedData) {\r\n        try {\r\n            const data = JSON.parse(savedData);\r\n            gifts = data.gifts || [];\r\n            audioUrl = data.audioUrl || null;\r\n            \r\n            // 更新音乐播放器UI状态\r\n            if (audioUrl) {\r\n                // 优先使用保存的原始文件名\r\n                const fileName = data.audioName || (() => {\r\n                    // 从URL中提取文件名作为备用\r\n                    const urlParts = audioUrl.split('/');\r\n                    return urlParts[urlParts.length - 1];\r\n                })();\r\n                document.getElementById('music-info').textContent = fileName;\r\n                \r\n                // 更新音乐文件名显示元素\r\n                const musicFilenameElement = document.getElementById('music-filename');\r\n                if (musicFilenameElement) {\r\n                    musicFilenameElement.textContent = fileName;\r\n                    musicFilenameElement.style.color = '#666';\r\n                }\r\n                \r\n                // 创建Howl实例\r\n                if (audio) {\r\n                    audio.unload();\r\n                }\r\n                audio = new Howl({\r\n                    src: [audioUrl],\r\n                    loop: true,\r\n                    volume: parseFloat(document.getElementById('volume').value)\r\n                });\r\n            } else {\r\n                document.getElementById('music-info').textContent = '未选择';\r\n                \r\n                // 清空音乐文件名显示元素\r\n                const musicFilenameElement = document.getElementById('music-filename');\r\n                if (musicFilenameElement) {\r\n                    musicFilenameElement.textContent = '未选择';\r\n                    musicFilenameElement.style.color = '#666';\r\n                }\r\n            }\r\n            \r\n            // 恢复主题色\r\n            if (data.theme) {\r\n                document.body.classList.remove('pink', 'white', 'blue');\r\n                document.body.classList.add(data.theme);\r\n                \r\n                // 更新颜色按钮状态\r\n                const colorBtns = document.querySelectorAll('.color-btn');\r\n                colorBtns.forEach(btn => {\r\n                    if (btn.dataset.color === data.theme) {\r\n                        btn.classList.add('active');\r\n                    } else {\r\n                        btn.classList.remove('active');\r\n                    }\r\n                });\r\n            }\r\n            \r\n            // 恢复标题\r\n            if (data.siteTitle) {\r\n                document.getElementById('site-title').value = data.siteTitle;\r\n            }\r\n            if (data.letterTitle) {\r\n                document.getElementById('letter-title').value = data.letterTitle;\r\n            }\r\n            // 恢复书信内容\r\n            if (data.letterContent && quill) {\r\n                quill.root.innerHTML = data.letterContent;\r\n            }\r\n            // 恢复礼物列表\r\n            renderGifts();\r\n        } catch (error) {\r\n            console.error('加载数据失败:', error);\r\n        }\r\n    }\r\n}\r\n\r\n// 保存数据到localStorage\r\nfunction saveToLocalStorage() {\r\n    // 获取当前主题色\r\n    const currentTheme = document.body.classList.contains('pink') ? 'pink' : \r\n                        document.body.classList.contains('white') ? 'white' : 'blue';\r\n    \r\n    const data = {\r\n        gifts: gifts,\r\n        audioUrl: audioUrl,\r\n        audioName: audioFile ? audioFile.name : null,\r\n        siteTitle: document.getElementById('site-title').value,\r\n        letterTitle: document.getElementById('letter-title').value,\r\n        letterContent: quill ? quill.root.innerHTML : '',\r\n        theme: currentTheme\r\n    };\r\n    localStorage.setItem('giftLetterData', JSON.stringify(data));\r\n    console.log('数据已保存到本地存储');\r\n}\r\n\r\n// 保存编辑状态到后端\r\nasync function saveEditState() {\r\n    try {\r\n        // 获取当前主题色\r\n        const currentTheme = document.body.classList.contains('pink') ? 'pink' : \r\n                            document.body.classList.contains('white') ? 'white' : 'blue';\r\n        \r\n        const data = {\r\n            editId: editId,\r\n            gifts: gifts,\r\n            audioUrl: audioUrl,\r\n            audioName: audioFile ? audioFile.name : null,\r\n            siteTitle: document.getElementById('site-title').value,\r\n            letterTitle: document.getElementById('letter-title').value,\r\n            letterContent: quill ? quill.root.innerHTML : '',\r\n            theme: currentTheme\r\n        };\r\n        \r\n        const response = await fetch(`${SERVER_URL}/api/save-edit`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json'\r\n            },\r\n            body: JSON.stringify(data)\r\n        });\r\n        \r\n        const result = await response.json();\r\n        if (result.success) {\r\n            editId = result.editId;\r\n            console.log('编辑状态已保存到后端');\r\n            showSaveStatus('💾 编辑状态保存成功啦～');\r\n\r\n            // 更新当前编辑ID显示\r\n            updateCurrentEditId();\r\n            return result.editId;\r\n        }\r\n    } catch (error) {\r\n        console.error('保存编辑状态失败:', error);\r\n    }\r\n    return null;\r\n}\r\n\r\n// 显示保存状态\r\nfunction showSaveStatus(message) {\r\n    // 创建或获取保存状态元素\r\n    let saveStatus = document.getElementById('save-status');\r\n    if (!saveStatus) {\r\n        saveStatus = document.createElement('div');\r\n        saveStatus.id = 'save-status';\r\n        saveStatus.style.cssText = `\r\n            position: fixed;\r\n            top: 20px;\r\n            right: 20px;\r\n            color: white;\r\n            padding: 12px 20px;\r\n            border-radius: 5px;\r\n            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);\r\n            z-index: 1000;\r\n            transition: all 0.3s ease;\r\n            opacity: 0;\r\n            transform: translateY(-20px);\r\n        `;\r\n        document.body.appendChild(saveStatus);\r\n    }\r\n    \r\n    // 设置消息并显示\r\n    saveStatus.textContent = message;\r\n    saveStatus.style.opacity = '1';\r\n    saveStatus.style.transform = 'translateY(0)';\r\n    \r\n    // 3秒后隐藏\r\n    setTimeout(() => {\r\n        saveStatus.style.opacity = '0';\r\n        saveStatus.style.transform = 'translateY(-20px)';\r\n    }, 3000);\r\n}\r\n\r\n// 从后端加载编辑状态\r\nasync function loadEditState(loadEditId) {\r\n    try {\r\n        const response = await fetch(`${SERVER_URL}/api/load-edit?editId=${loadEditId}`);\r\n        const result = await response.json();\r\n        if (result.success) {\r\n            const data = result.data;\r\n            editId = data.editId;\r\n            gifts = data.gifts || [];\r\n            audioUrl = data.audioUrl || null;\r\n            \r\n            // 更新音乐播放器UI状态\r\n            if (audioUrl) {\r\n                // 优先使用保存的原始文件名\r\n                const fileName = data.audioName || (() => {\r\n                    // 从URL中提取文件名作为备用\r\n                    const urlParts = audioUrl.split('/');\r\n                    return urlParts[urlParts.length - 1];\r\n                })();\r\n                document.getElementById('music-info').textContent = fileName;\r\n                \r\n                // 更新音乐文件名显示元素\r\n                const musicFilenameElement = document.getElementById('music-filename');\r\n                if (musicFilenameElement) {\r\n                    musicFilenameElement.textContent = fileName;\r\n                    musicFilenameElement.style.color = '#666';\r\n                }\r\n                \r\n                // 创建Howl实例\r\n                if (audio) {\r\n                    audio.unload();\r\n                }\r\n                audio = new Howl({\r\n                    src: [audioUrl],\r\n                    loop: true,\r\n                    volume: parseFloat(document.getElementById('volume').value)\r\n                });\r\n            } else {\r\n                document.getElementById('music-info').textContent = '未选择';\r\n                \r\n                // 清空音乐文件名显示元素\r\n                const musicFilenameElement = document.getElementById('music-filename');\r\n                if (musicFilenameElement) {\r\n                    musicFilenameElement.textContent = '未选择';\r\n                    musicFilenameElement.style.color = '#666';\r\n                }\r\n            }\r\n            \r\n            // 恢复主题色\r\n            if (data.theme) {\r\n                document.body.classList.remove('pink', 'white', 'blue');\r\n                document.body.classList.add(data.theme);\r\n                \r\n                // 更新颜色按钮状态\r\n                const colorBtns = document.querySelectorAll('.color-btn');\r\n                colorBtns.forEach(btn => {\r\n                    if (btn.dataset.color === data.theme) {\r\n                        btn.classList.add('active');\r\n                    } else {\r\n                        btn.classList.remove('active');\r\n                    }\r\n                });\r\n            }\r\n            \r\n            // 恢复标题\r\n            if (data.siteTitle) {\r\n                document.getElementById('site-title').value = data.siteTitle;\r\n            }\r\n            if (data.letterTitle) {\r\n                document.getElementById('letter-title').value = data.letterTitle;\r\n            }\r\n            // 恢复书信内容\r\n            if (data.letterContent && quill) {\r\n                quill.root.innerHTML = data.letterContent;\r\n            }\r\n            // 恢复礼物列表\r\n            renderGifts();\r\n            \r\n            showSaveStatus('🔄 编辑状态恢复成功啦～');\r\n\r\n            return true;\r\n        }\r\n    } catch (error) {\r\n        console.error('加载编辑状态失败:', error);\r\n        showSaveStatus('加载编辑状态失败');\r\n    }\r\n    return false;\r\n}\r\n\r\n// 上传文件到服务器\r\nfunction uploadFileToServer(file) {\r\n    return new Promise((resolve, reject) => {\r\n        const formData = new FormData();\r\n        formData.append('file', file);\r\n        \r\n        fetch(`${SERVER_URL}/api/upload`, {\r\n            method: 'POST',\r\n            body: formData\r\n        })\r\n        .then(response => {\r\n            if (!response.ok) {\r\n                throw new Error('Upload failed');\r\n            }\r\n            return response.json();\r\n        })\r\n        .then(data => {\r\n            if (data.error) {\r\n                reject(data.error);\r\n            } else {\r\n                resolve(data.url);\r\n            }\r\n        })\r\n        .catch(error => {\r\n            console.error('Upload error:', error);\r\n            reject(error);\r\n        });\r\n    });\r\n}\r\n\r\n// 初始化字体选择器\r\nfunction initFontSelector() {\r\n    const fontSelect = document.getElementById('font-select');\r\n    const fontPreview = document.getElementById('font-preview');\r\n    \r\n    if (fontSelect && fontPreview) {\r\n        // 字体选择事件\r\n        fontSelect.addEventListener('change', function() {\r\n            const selectedFont = this.value;\r\n            \r\n            // 更新预览区域字体\r\n            fontPreview.style.fontFamily = selectedFont;\r\n            \r\n            // 更新页面全局字体\r\n            document.body.style.fontFamily = selectedFont;\r\n            \r\n            // 更新Quill编辑器字体\r\n            if (quill) {\r\n                const editor = document.querySelector('.ql-editor');\r\n                if (editor) {\r\n                    editor.style.fontFamily = selectedFont;\r\n                }\r\n            }\r\n            \r\n            // 更新礼物备注字体\r\n            const giftNotes = document.querySelectorAll('.gift-note');\r\n            giftNotes.forEach(note => {\r\n                note.style.fontFamily = selectedFont;\r\n            });\r\n            \r\n            console.log('字体已更新为:', selectedFont);\r\n        });\r\n        \r\n        // 初始化预览字体\r\n        fontPreview.style.fontFamily = fontSelect.value;\r\n    }\r\n}\r\n\r\n// 初始化页面\r\nfunction initPage() {\r\n    initQuill();\r\n    initColorPicker();\r\n    initGiftManagement();\r\n    initMusicPlayer();\r\n    initGenerateButtons();\r\n    initModals();\r\n    initSortable();\r\n    initFontSelector();\r\n    \r\n    // 清理可能存在的事件监听器\r\n    const giftGrid = document.getElementById('gift-grid');\r\n    giftGrid.innerHTML = giftGrid.innerHTML;\r\n    \r\n    // 检查URL参数中是否有editId\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    const urlEditId = urlParams.get('editId');\r\n    if (urlEditId) {\r\n        // 延迟加载编辑状态，确保页面元素已初始化\r\n        setTimeout(() => {\r\n            loadEditState(urlEditId);\r\n        }, 500);\r\n    } else {\r\n        // 从localStorage加载数据\r\n        loadFromLocalStorage();\r\n    }\r\n    \r\n    // 初始化表情掉落动画\r\n    initEmojiRain();\r\n}\r\n\r\n// 初始化富文本编辑器\r\nfunction initQuill() {\r\n    quill = new Quill('#letter-content', {\r\n        theme: 'snow',\r\n        modules: {\r\n            toolbar: [\r\n                ['bold', 'italic', 'underline'],\r\n                ['blockquote', 'code-block'],\r\n                [{ 'header': 1 }, { 'header': 2 }],\r\n                [{ 'list': 'ordered' }, { 'list': 'bullet' }],\r\n                [{ 'color': [] }, { 'background': [] }],\r\n                [{ 'align': [] }],\r\n                ['clean']\r\n            ]\r\n        },\r\n        placeholder: '请输入书信内容...',\r\n        // 设置默认字体\r\n        formats: ['font', 'size', 'bold', 'italic', 'underline', 'strike', 'blockquote', 'code-block', 'header', 'list', 'bullet', 'indent', 'link', 'image', 'color', 'background', 'align'],\r\n        defaultFont: 'Comic Neue'\r\n    });\r\n    \r\n    // 确保编辑器内容使用可爱字体\r\n    quill.on('editor-change', function() {\r\n        const editor = document.querySelector('.ql-editor');\r\n        if (editor) {\r\n            editor.style.fontFamily = \"'Comic Neue', 'Nunito', 'Microsoft YaHei', Arial, sans-serif\";\r\n            editor.style.fontSize = '18px';\r\n        }\r\n    });\r\n}\r\n\r\n// 初始化颜色选择器\r\nfunction initColorPicker() {\r\n    const colorBtns = document.querySelectorAll('.color-btn');\r\n    colorBtns.forEach(btn => {\r\n        btn.addEventListener('click', () => {\r\n            // 移除所有按钮的active类\r\n            colorBtns.forEach(b => b.classList.remove('active'));\r\n            // 添加当前按钮的active类\r\n            btn.classList.add('active');\r\n            // 更改body的颜色类\r\n            const color = btn.dataset.color;\r\n            document.body.className = color;\r\n        });\r\n    });\r\n}\r\n\r\n// 初始化礼物管理\r\nfunction initGiftManagement() {\r\n    // 添加礼物按钮\r\n    document.getElementById('add-gift').addEventListener('click', () => {\r\n        currentGiftIndex = -1;\r\n        openGiftModal();\r\n    });\r\n}\r\n\r\n// 打开礼物编辑弹窗\r\nfunction openGiftModal() {\r\n    document.getElementById('gift-modal').style.display = 'block';\r\n    // 重置文件输入\r\n    document.getElementById('gift-file').value = '';\r\n    \r\n    // 如果是添加新礼物，清空备注并隐藏媒体预览\r\n    if (currentGiftIndex === -1) {\r\n        document.getElementById('gift-note').value = '';\r\n        const currentMediaPreview = document.getElementById('current-media-preview');\r\n        const mediaPreviewContent = document.getElementById('media-preview-content');\r\n        currentMediaPreview.style.display = 'none';\r\n        mediaPreviewContent.innerHTML = '';\r\n    }\r\n}\r\n\r\n// 关闭礼物编辑弹窗\r\nfunction closeGiftModal() {\r\n    document.getElementById('gift-modal').style.display = 'none';\r\n}\r\n\r\n// 处理文件选择，添加裁剪步骤\r\nfunction handleFileSelect(e) {\r\n    const file = e.target.files[0];\r\n    if (!file) return;\r\n    \r\n    currentFile = file;\r\n    \r\n    if (file.type.startsWith('image/')) {\r\n        // 图片需要裁剪\r\n        openCropModal(file);\r\n    } else {\r\n        // 视频直接上传\r\n        saveGiftWithFile(file);\r\n    }\r\n}\r\n\r\n// 打开裁剪弹窗\r\nfunction openCropModal(file) {\r\n    const reader = new FileReader();\r\n    reader.onload = function(e) {\r\n        const img = document.getElementById('crop-image');\r\n        img.src = e.target.result;\r\n        \r\n        // 初始化裁剪器\r\n        if (cropper) {\r\n            cropper.destroy();\r\n        }\r\n        \r\n        cropper = new Cropper(img, {\r\n            aspectRatio: 1, // 1:1比例\r\n            viewMode: 1,\r\n            dragMode: 'move',\r\n            autoCropArea: 0.8, // 默认裁剪区域大小\r\n            cropBoxMovable: true,\r\n            cropBoxResizable: true\r\n        });\r\n        \r\n        // 显示裁剪弹窗\r\n        document.getElementById('crop-modal').style.display = 'block';\r\n    };\r\n    reader.readAsDataURL(file);\r\n}\r\n\r\n// 关闭裁剪弹窗\r\nfunction closeCropModal() {\r\n    if (cropper) {\r\n        cropper.destroy();\r\n        cropper = null;\r\n    }\r\n    document.getElementById('crop-modal').style.display = 'none';\r\n    currentFile = null;\r\n}\r\n\r\n// 全局变量：存储裁剪后的文件\r\nlet croppedFile = null;\r\n// 全局变量：跟踪添加礼物的状态\r\nlet isAddingGift = false;\r\n\r\n// 确认裁剪\r\nasync function confirmCrop() {\r\n    if (!cropper || isAddingGift) return;\r\n    \r\n    try {\r\n        console.log('开始裁剪图片');\r\n        // 设置添加礼物状态\r\n        isAddingGift = true;\r\n        \r\n        // 获取裁剪后的图片\r\n        const canvas = cropper.getCroppedCanvas({\r\n            width: 800,\r\n            height: 800,\r\n            fillColor: '#fff',\r\n            imageSmoothingEnabled: true\r\n        });\r\n        \r\n        // 将canvas转换为blob\r\n        canvas.toBlob(function(blob) {\r\n            console.log('裁剪完成，创建文件对象');\r\n            // 创建新的File对象\r\n            croppedFile = new File([blob], currentFile.name, {\r\n                type: currentFile.type,\r\n                lastModified: Date.now()\r\n            });\r\n            \r\n            console.log('关闭裁剪弹窗');\r\n            // 关闭裁剪弹窗，返回礼物编辑弹窗\r\n            closeCropModal();\r\n            \r\n            console.log('显示提示信息');\r\n            // 显示提示信息，让用户填写备注\r\n            alert('✂️ 裁剪完成啦～请填写礼物备注后点击保存哦 🎁');\r\n\r\n            \r\n            console.log('裁剪流程完成，礼物编辑弹窗应该仍然打开');\r\n            \r\n            // 重置添加礼物状态\r\n            isAddingGift = false;\r\n        }, currentFile.type);\r\n    } catch (error) {\r\n        console.error('裁剪失败:', error);\r\n        alert('😢 裁剪失败了～请再试一次吧 💪');\r\n\r\n        // 重置添加礼物状态\r\n        isAddingGift = false;\r\n    }\r\n}\r\n\r\n// 保存礼物（带文件参数）\r\nasync function saveGiftWithFile(file) {\r\n    if (isAddingGift) return;\r\n    \r\n    const noteInput = document.getElementById('gift-note');\r\n    const note = noteInput.value;\r\n    \r\n    try {\r\n        console.log('开始上传文件:', file.name);\r\n        // 设置添加礼物状态\r\n        isAddingGift = true;\r\n        \r\n        // 上传文件到服务器\r\n        const url = await uploadFileToServer(file);\r\n        console.log('文件上传成功，URL:', url);\r\n        \r\n        let gift;\r\n        if (currentGiftIndex === -1) {\r\n            // 添加新礼物\r\n            gift = {\r\n                id: Date.now(),\r\n                file: file,\r\n                url: url,\r\n                note: note,\r\n                type: file.type.startsWith('image/') ? 'image' : 'video'\r\n            };\r\n            gifts.push(gift);\r\n            console.log('新礼物添加成功:', gift.id);\r\n        } else {\r\n            // 编辑现有礼物，保留原始ID\r\n            gift = gifts[currentGiftIndex];\r\n            gift.file = file;\r\n            gift.url = url;\r\n            gift.note = note;\r\n            gift.type = file.type.startsWith('image/') ? 'image' : 'video';\r\n            // 保留原始ID\r\n            console.log('礼物编辑成功:', gift.id);\r\n        }\r\n        \r\n        // 重新渲染礼物列表\r\n        renderGifts();\r\n        // 关闭弹窗\r\n        closeGiftModal();\r\n        // 保存到本地存储\r\n        saveToLocalStorage();\r\n        // 显示保存成功提示\r\n        showSaveStatus('🎉 礼物保存成功啦～');\r\n\r\n        console.log('礼物保存完成');\r\n    } catch (error) {\r\n        console.error('保存礼物失败:', error);\r\n        console.error('错误详情:', error.message);\r\n        // 显示更详细的错误信息\r\n        alert('😢 上传失败了～请再试一次吧 💪\\n\\n错误信息: ' + error.message);\r\n\r\n    } finally {\r\n        // 重置添加礼物状态\r\n        isAddingGift = false;\r\n        // 重置裁剪文件\r\n        croppedFile = null;\r\n    }\r\n}\r\n\r\n// 保存礼物\r\nfunction saveGift() {\r\n    if (isAddingGift) {\r\n        alert('⏰ 礼物正在添加中，请稍候哦～ 🎀');\r\n        return;\r\n    }\r\n\r\n    \r\n    const fileInput = document.getElementById('gift-file');\r\n    const noteInput = document.getElementById('gift-note');\r\n    const note = noteInput.value;\r\n    \r\n    console.log('开始保存礼物');\r\n    console.log('currentGiftIndex:', currentGiftIndex);\r\n    console.log('fileInput.files.length:', fileInput.files.length);\r\n    console.log('croppedFile:', croppedFile);\r\n    console.log('note:', note);\r\n    \r\n    // 如果是编辑现有礼物且没有选择新文件，只更新备注\r\n    if (currentGiftIndex !== -1 && !fileInput.files.length && !croppedFile) {\r\n        console.log('编辑现有礼物，只更新备注');\r\n        const gift = gifts[currentGiftIndex];\r\n        // 更新备注\r\n        gift.note = note;\r\n        // 重新渲染礼物列表\r\n        renderGifts();\r\n        // 关闭弹窗\r\n        closeGiftModal();\r\n        // 保存到本地存储\r\n        saveToLocalStorage();\r\n        // 显示保存成功提示\r\n        showSaveStatus('📝 礼物备注更新成功啦～');\r\n\r\n        return;\r\n    }\r\n    \r\n    // 检查是否有裁剪后的文件\r\n    if (croppedFile) {\r\n        console.log('使用裁剪后的文件保存礼物');\r\n        // 使用裁剪后的文件\r\n        saveGiftWithFile(croppedFile);\r\n    } else if (fileInput.files.length) {\r\n        console.log('处理用户选择的文件');\r\n        // 处理文件选择\r\n        handleFileSelect({ target: fileInput });\r\n    } else {\r\n        console.log('没有选择文件');\r\n        alert('🎁 请先选择礼物素材哦～');\r\n        return;\r\n\r\n    }\r\n}\r\n\r\n// 渲染礼物列表\nfunction renderGifts() {\n    const giftGrid = document.getElementById('gift-grid');\n    giftGrid.innerHTML = '';\n    \n    gifts.forEach((gift, index) => {\n        const giftItem = document.createElement('div');\n        giftItem.className = 'gift-item';\n        \n        let mediaElement = '';\n        if (gift.type === 'image') {\n            mediaElement = `<img src=\"${gift.url}\" alt=\"礼物图片\" class=\"gift-media\" onerror=\"this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22 viewBox=%220 0 200 200%22%3E%3Crect width=%22200%22 height=%22200%22 fill=%22%23f5f5f5%22/%3E%3Ctext x=%22100%22 y=%22100%22 font-family=%22Arial%22 font-size=%2216%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22%23999%22%3E图片加载失败%3C/text%3E%3C/svg%3E'\">\n            <button onclick=\"previewImage(${index})\" class=\"preview-btn\">预览</button>`;\n        } else {\n            mediaElement = `<video src=\"${gift.url}\" class=\"gift-media\">\n            <button onclick=\"this.previousElementSibling.play()\" class=\"preview-btn\">播放</button>`;\n        }\n        \n        giftItem.innerHTML = `\n            <div class=\"gift-media-container\">\n                ${mediaElement}\n            </div>\n            <div class=\"gift-note\">${gift.note || '无备注'}</div>\n            <div class=\"gift-actions\">\n                <button onclick=\"editGift(${index})\" class=\"edit-btn\">编辑</button>\n                <button onclick=\"confirmAndDelete(${index})\" class=\"delete-btn\">删除</button>\n            </div>\n        `;\n        \n        giftGrid.appendChild(giftItem);\n    });\n}\r\n\r\n// 添加一次性事件监听器\r\nfunction addSingleEventListeners() {\r\n    const giftGrid = document.getElementById('gift-grid');\r\n    \r\n    // 点击媒体文件\r\n    giftGrid.addEventListener('click', function(e) {\r\n        if (e.target.tagName === 'IMG' || e.target.tagName === 'VIDEO') {\r\n            const giftItem = e.target.closest('.gift-item');\r\n            const deleteBtn = giftItem.querySelector('.delete-btn');\r\n            const index = parseInt(deleteBtn.dataset.index);\r\n            if (!isNaN(index)) {\r\n                if (e.target.tagName === 'IMG') {\r\n                    previewImage(index);\r\n                } else if (e.target.tagName === 'VIDEO') {\r\n                    e.target.play();\r\n                }\r\n            }\r\n        }\r\n    });\r\n    \r\n    // 点击编辑按钮\r\n    giftGrid.addEventListener('click', function(e) {\r\n        if (e.target.classList.contains('edit-btn')) {\r\n            e.stopPropagation();\r\n            const index = parseInt(e.target.dataset.index);\r\n            if (!isNaN(index)) {\r\n                editGift(index);\r\n            }\r\n        }\r\n    });\r\n    \r\n\r\n}\r\n\r\n// 直接删除礼物\r\nfunction confirmAndDelete(index) {\r\n    console.log('删除按钮被点击，索引:', index);\r\n    console.log('当前gifts数组长度:', gifts.length);\r\n    \r\n    // 直接执行删除操作，不弹出确认框\r\n    if (index >= 0 && index < gifts.length) {\r\n        // 执行删除\r\n        gifts.splice(index, 1);\r\n        console.log('删除后gifts数组长度:', gifts.length);\r\n        // 重新渲染\r\n        renderGifts();\r\n        // 保存到本地存储\r\n        saveToLocalStorage();\r\n        showSaveStatus('🗑️ 礼物删除成功啦～');\r\n    } else {\r\n        console.error('索引超出范围:', index);\r\n        alert('😢 删除失败了～索引超出范围啦 💪');\r\n    }\r\n}\r\n\r\n// 编辑礼物\r\nfunction editGift(index) {\r\n    currentGiftIndex = index;\r\n    const gift = gifts[index];\r\n    document.getElementById('gift-note').value = gift.note;\r\n    \r\n    // 显示当前媒体文件预览\r\n    const currentMediaPreview = document.getElementById('current-media-preview');\r\n    const mediaPreviewContent = document.getElementById('media-preview-content');\r\n    \r\n    if (gift && gift.url) {\r\n        // 显示预览区域\r\n        currentMediaPreview.style.display = 'block';\r\n        \r\n        // 根据礼物类型显示不同的预览\r\n        if (gift.type === 'image') {\r\n            mediaPreviewContent.innerHTML = `<img src=\"${gift.url}\" alt=\"礼物图片\" style=\"max-width: 100%; max-height: 200px; border-radius: 3px;\">`;\r\n        } else if (gift.type === 'video') {\r\n            mediaPreviewContent.innerHTML = `<video src=\"${gift.url}\" style=\"max-width: 100%; max-height: 200px; border-radius: 3px;\" controls></video>`;\r\n        }\r\n    } else {\r\n        // 隐藏预览区域\r\n        currentMediaPreview.style.display = 'none';\r\n        mediaPreviewContent.innerHTML = '';\r\n    }\r\n    \r\n    openGiftModal();\r\n}\r\n\r\n// 删除礼物\r\nfunction deleteGift(index) {\r\n    console.log('删除按钮被点击，索引:', index);\r\n    console.log('当前gifts数组长度:', gifts.length);\r\n    console.log('当前gifts数组:', gifts);\r\n    \r\n    // 显示确认对话框\r\n    const confirmed = confirm('确定要删除这个礼物吗？删除后无法恢复。');\r\n    console.log('用户确认:', confirmed);\r\n    \r\n    if (confirmed) {\r\n        console.log('执行删除操作，索引:', index);\r\n        if (index >= 0 && index < gifts.length) {\r\n            // 执行删除\r\n            gifts.splice(index, 1);\r\n            console.log('删除后gifts数组长度:', gifts.length);\r\n            // 重新渲染\r\n            renderGifts();\r\n            // 保存到本地存储\r\n            saveToLocalStorage();\r\n            showSaveStatus('礼物删除成功');\r\n        } else {\r\n            console.error('索引超出范围:', index);\r\n            alert('删除失败：索引超出范围');\r\n        }\r\n    } else {\r\n        console.log('用户取消删除操作');\r\n    }\r\n}\r\n\r\n// 预览图片\r\nfunction previewImage(index) {\r\n    const gift = gifts[index];\r\n    if (gift.type === 'image') {\r\n        // 这里可以实现图片预览功能\r\n        console.log('预览图片:', gift.url);\r\n    }\r\n}\r\n\r\n\r\n\r\n// 初始化生成按钮\r\nfunction initGenerateButtons() {\r\n    // 预览按钮\r\n    document.getElementById('preview-btn').addEventListener('click', function() {\r\n        previewShowPage();\r\n    });\r\n    \r\n    // 生成按钮\r\n    document.getElementById('generate-btn').addEventListener('click', function() {\r\n        generateShowPackage();\r\n    });\r\n}\r\n\r\n// 预览展示页\r\nfunction previewShowPage() {\r\n    const previewContent = document.getElementById('preview-content');\r\n    const siteTitle = document.getElementById('site-title').value;\r\n    const letterTitle = document.getElementById('letter-title').value;\r\n    const letterContent = quill.root.innerHTML;\r\n    \r\n    // 构建预览内容\r\n    let html = `\r\n        <h1>${siteTitle}</h1>\r\n        <h2>礼物</h2>\r\n        <div class=\"gift-grid\">\r\n    `;\r\n    \r\n    gifts.forEach(gift => {\r\n        let mediaElement = '';\r\n        if (gift.type === 'image') {\r\n            mediaElement = `<img src=\"${gift.url}\" alt=\"礼物图片\" class=\"gift-media\">`;\r\n        } else {\r\n            mediaElement = `<video src=\"${gift.url}\" class=\"gift-media\"></video>`;\r\n        }\r\n        \r\n        html += `\r\n            <div class=\"gift-item\">\r\n                <div class=\"gift-media-container\">\r\n                    ${mediaElement}\r\n                </div>\r\n                <div class=\"gift-note\">${gift.note || '无备注'}</div>\r\n            </div>\r\n        `;\r\n    });\r\n    \r\n    html += `\r\n        </div>\r\n        <h2>${letterTitle}</h2>\r\n        <div class=\"letter-content\">${letterContent}</div>\r\n        <div class=\"music-player\">\r\n            <span>背景音乐: ${audioFile ? audioFile.name : '未选择'}</span>\r\n        </div>\r\n    `;\r\n    \r\n    previewContent.innerHTML = html;\r\n    document.getElementById('preview-modal').style.display = 'block';\r\n}\r\n\r\n// 生成展示包\r\nasync function generateShowPackage() {\r\n    try {\r\n        // 保存编辑状态\r\n        await saveEditState();\r\n        \r\n        const siteTitle = document.getElementById('site-title').value || '我的礼物';\r\n        const letterTitle = document.getElementById('letter-title').value || '生日祝福';\r\n        const letterContent = quill.root.innerHTML;\r\n        \r\n        // 获取当前主题色\r\n        const currentTheme = document.body.classList.contains('pink') ? 'pink' : \r\n                            document.body.classList.contains('white') ? 'white' : 'blue';\r\n        \r\n        // 准备展示数据\r\n        const showData = {\r\n            siteTitle: siteTitle,\r\n            letterTitle: letterTitle,\r\n            letterContent: letterContent,\r\n            gifts: gifts.map(gift => ({\r\n                id: gift.id,\r\n                url: gift.url,\r\n                note: gift.note,\r\n                type: gift.type\r\n            })),\r\n            audioUrl: audioUrl,\r\n            audioName: audioFile ? audioFile.name : null,\r\n            theme: currentTheme\r\n        };\r\n        \r\n        // 保存到后端并获取分享链接\r\n        const response = await fetch(`${SERVER_URL}/api/save-show`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json'\r\n            },\r\n            body: JSON.stringify(showData)\r\n        });\r\n        \r\n        const result = await response.json();\r\n        \r\n        if (result.success) {\r\n            // 显示生成成功信息和分享链接\r\n            let editLink = '';\r\n            if (editId) {\r\n                editLink = `<p style=\"margin-top: 10px;\">编辑链接（用于后续修改）：</p>\r\n                <p style=\"background-color: #f0f0f0; padding: 15px; border-radius: 5px; word-break: break-all;\">\r\n                    ${SERVER_URL}/edit.html?editId=${editId}\r\n                </p>`;\r\n            }\r\n            \r\n            document.getElementById('generate-info').innerHTML = `\r\n                <p style=\"color: green;\">生成成功！请将以下链接分享给对方：</p>\r\n                <p style=\"background-color: #f0f0f0; padding: 15px; border-radius: 5px; word-break: break-all;\">\r\n                    ${result.shareUrl}\r\n                </p>\r\n                ${editLink}\r\n                <p style=\"color: blue;\">注意：此链接永久有效，请妥善保管。</p>\r\n            `;\r\n            \r\n            // 复制链接到剪贴板\r\n            try {\r\n                await navigator.clipboard.writeText(result.shareUrl);\r\n                document.getElementById('generate-info').innerHTML += `\r\n                    <p style=\"color: green; font-size: 14px;\">✅ 分享链接已复制到剪贴板</p>\r\n                `;\r\n            } catch (clipboardError) {\r\n                console.log('无法复制到剪贴板:', clipboardError);\r\n            }\r\n        } else {\r\n            document.getElementById('generate-info').innerHTML = `\r\n                <p style=\"color: red;\">生成失败: ${result.error}</p>\r\n            `;\r\n        }\r\n    } catch (error) {\r\n        console.error('生成分享链接失败:', error);\r\n        document.getElementById('generate-info').innerHTML = `\r\n            <p style=\"color: red;\">生成失败，请重试。</p>\r\n        `;\r\n    }\r\n}\r\n\r\n// 更新当前编辑ID显示\r\nfunction updateCurrentEditId() {\r\n    const currentEditIdElement = document.getElementById('current-edit-id');\r\n    if (currentEditIdElement) {\r\n        if (editId) {\r\n            currentEditIdElement.textContent = `当前编辑ID: ${editId} (可用于后续恢复编辑)`;\r\n        } else {\r\n            currentEditIdElement.textContent = '未保存编辑状态';\r\n        }\r\n    }\r\n}\r\n\r\n// 初始化弹窗\r\nfunction initModals() {\r\n    // 关闭礼物弹窗\r\n    document.querySelector('#gift-modal .close').addEventListener('click', closeGiftModal);\r\n    \r\n    // 关闭预览弹窗\r\n    document.querySelector('#preview-modal .close').addEventListener('click', function() {\r\n        document.getElementById('preview-modal').style.display = 'none';\r\n    });\r\n    \r\n    // 关闭裁剪弹窗\r\n    document.querySelector('#crop-modal .close').addEventListener('click', closeCropModal);\r\n    document.getElementById('cancel-crop').addEventListener('click', closeCropModal);\r\n    document.getElementById('confirm-crop').addEventListener('click', confirmCrop);\r\n    \r\n    // 点击弹窗外部关闭\r\n    window.addEventListener('click', function(e) {\r\n        const giftModal = document.getElementById('gift-modal');\r\n        const previewModal = document.getElementById('preview-modal');\r\n        const cropModal = document.getElementById('crop-modal');\r\n        \r\n        if (e.target === giftModal) {\r\n            closeGiftModal();\r\n        }\r\n        \r\n        if (e.target === previewModal) {\r\n            previewModal.style.display = 'none';\r\n        }\r\n        \r\n        if (e.target === cropModal) {\r\n            closeCropModal();\r\n        }\r\n    });\r\n    \r\n    // 保存礼物按钮\r\n    document.getElementById('save-gift').addEventListener('click', saveGift);\r\n    \r\n    // 文件选择事件\r\n    document.getElementById('gift-file').addEventListener('change', handleFileSelect);\r\n    \r\n    // 标题和内容变化时自动保存\r\n    document.getElementById('site-title').addEventListener('input', saveToLocalStorage);\r\n    document.getElementById('letter-title').addEventListener('input', saveToLocalStorage);\r\n    \r\n    // 延迟添加Quill监听，确保Quill已初始化\r\n    setTimeout(() => {\r\n        if (quill) {\r\n            quill.on('text-change', saveToLocalStorage);\r\n            console.log('已添加Quill文本变化监听');\r\n        }\r\n    }, 500);\r\n    \r\n    // 恢复编辑状态按钮\r\n    const loadEditBtn = document.getElementById('load-edit-btn');\r\n    if (loadEditBtn) {\r\n        loadEditBtn.addEventListener('click', function() {\r\n            const editIdInput = document.getElementById('edit-id-input');\r\n            const inputEditId = editIdInput.value.trim();\r\n            if (inputEditId) {\r\n                loadEditState(inputEditId);\r\n            } else {\r\n                alert('请输入编辑ID');\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n// 初始化拖拽排序\r\nfunction initSortable() {\r\n    const giftGrid = document.getElementById('gift-grid');\r\n    new Sortable(giftGrid, {\r\n        animation: 150,\r\n        ghostClass: 'sortable-ghost', // 添加拖拽时的幽灵元素样式\r\n        chosenClass: 'sortable-chosen', // 添加选中元素的样式\r\n        dragClass: 'sortable-drag', // 添加拖拽元素的样式\r\n        onStart: function(evt) {\r\n            // 排序开始时的视觉反馈\r\n            const draggedElement = evt.item;\r\n            draggedElement.style.opacity = '0.5';\r\n        },\r\n        onEnd: function(evt) {\r\n            // 排序结束时的视觉反馈\r\n            const draggedElement = evt.item;\r\n            draggedElement.style.opacity = '1';\r\n            \r\n            // 重新排序礼物数组\r\n            const draggedGift = gifts.splice(evt.oldIndex, 1)[0];\r\n            gifts.splice(evt.newIndex, 0, draggedGift);\r\n            // 重新渲染礼物列表，确保删除按钮的index值与当前gifts数组顺序一致\r\n            renderGifts();\r\n            // 保存到本地存储\r\n            saveToLocalStorage();\r\n            showSaveStatus('礼物顺序已更新');\r\n        }\r\n    });\r\n}\r\n\r\n// 初始化音乐播放器\r\nfunction initMusicPlayer() {\r\n    // 音乐上传按钮点击事件\r\n    document.getElementById('music-upload-btn').addEventListener('click', function() {\r\n        document.getElementById('music-upload').click();\r\n    });\r\n    \r\n    // 音乐上传\r\n    document.getElementById('music-upload').addEventListener('change', async function(e) {\r\n        const file = e.target.files[0];\r\n        if (file && file.type.startsWith('audio/')) {\r\n            try {\r\n                // 先更新音乐信息，显示正在上传\r\n                document.getElementById('music-info').textContent = '上传中...';\r\n                \r\n                // 上传文件到服务器\r\n                const url = await uploadFileToServer(file);\r\n                \r\n                // 替换音乐\r\n                if (audio) {\r\n                    audio.unload();\r\n                    showSaveStatus('🎵 音乐已替换～');\r\n                } else {\r\n                    showSaveStatus('🎵 音乐保存成功啦～');\r\n                }\r\n                \r\n                audioFile = file;\r\n                audioUrl = url;\r\n                document.getElementById('music-info').textContent = file.name;\r\n                \r\n                // 更新音乐文件名显示元素\r\n                const musicFilenameElement = document.getElementById('music-filename');\r\n                if (musicFilenameElement) {\r\n                    musicFilenameElement.textContent = file.name;\r\n                    musicFilenameElement.style.color = '#666';\r\n                }\r\n                \r\n                // 创建新的Howl实例\r\n                audio = new Howl({\r\n                    src: [url],\r\n                    loop: true,\r\n                    volume: parseFloat(document.getElementById('volume').value)\r\n                });\r\n                \r\n                // 保存到本地存储\r\n                saveToLocalStorage();\r\n\r\n            } catch (error) {\r\n                console.error('上传音乐失败:', error);\r\n                document.getElementById('music-info').textContent = '上传失败';\r\n                alert('😢 音乐上传失败了～请再试一次吧 💪');\r\n\r\n            }\r\n        } else if (file) {\r\n            alert('🎵 请选择音频文件哦～');\r\n        }\r\n    });\r\n    \r\n    // 清除音乐\r\n    document.getElementById('clear-music').addEventListener('click', function() {\r\n        if (audio) {\r\n            audio.unload();\r\n            audio = null;\r\n        }\r\n        audioFile = null;\r\n        audioUrl = null;\r\n        document.getElementById('music-info').textContent = '未选择';\r\n        document.getElementById('play-btn').textContent = '播放';\r\n        \r\n        // 清空音乐文件名显示元素\r\n        const musicFilenameElement = document.getElementById('music-filename');\r\n        if (musicFilenameElement) {\r\n            musicFilenameElement.textContent = '未选择';\r\n            musicFilenameElement.style.color = '#666';\r\n        }\r\n        \r\n        // 保存到本地存储\r\n        saveToLocalStorage();\r\n        showSaveStatus('🎵 音乐已清除～');\r\n    });\r\n    \r\n    // 播放/暂停按钮\r\n    document.getElementById('play-btn').addEventListener('click', function() {\r\n        if (audio) {\r\n            if (audio.playing()) {\r\n                audio.pause();\r\n                this.textContent = '播放';\r\n            } else {\r\n                audio.play();\r\n                this.textContent = '暂停';\r\n            }\r\n        } else {\r\n            showSaveStatus('🎵 请先选择音乐哦～');\r\n        }\r\n    });\r\n    \r\n    // 音量控制\r\n    document.getElementById('volume').addEventListener('input', function() {\r\n        const volume = parseFloat(this.value);\r\n        if (audio) {\r\n            audio.volume(volume);\r\n        }\r\n    });\r\n}\r\n\r\n// 初始化表情掉落动画\r\nfunction initEmojiRain() {\r\n    const letterContent = document.querySelector('.letter-content');\r\n    \r\n    // 可爱表情集合\r\n    const emojis = ['😊', '🥰', '🤩', '🌟', '🎀', '🎉', '✨', '💖', '🌸', '🦋', '🌈', '💝', '💗', '💓', '💞'];\r\n    \r\n    // 当用户输入时触发表情掉落\r\n    if (quill) {\r\n        quill.on('text-change', function() {\r\n            // 随机决定是否触发，避免过于频繁\r\n            if (Math.random() > 0.7) {\r\n                createEmojiRain(letterContent, emojis);\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n// 创建表情掉落效果\r\nfunction createEmojiRain(container, emojis) {\r\n    // 限制同时显示的表情数量\r\n    const existingEmojis = container.querySelectorAll('.emoji-rain');\r\n    if (existingEmojis.length > 10) return;\r\n    \r\n    // 创建多个表情\r\n    const emojiCount = Math.floor(Math.random() * 3) + 1;\r\n    \r\n    for (let i = 0; i < emojiCount; i++) {\r\n        const emoji = document.createElement('div');\r\n        emoji.className = 'emoji-rain';\r\n        emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];\r\n        \r\n        // 随机位置和样式\r\n        const left = Math.random() * 100;\r\n        const fontSize = Math.random() * 20 + 20;\r\n        const duration = Math.random() * 3 + 2;\r\n        \r\n        emoji.style.position = 'absolute';\r\n        emoji.style.left = `${left}%`;\r\n        emoji.style.top = '-30px';\r\n        emoji.style.fontSize = `${fontSize}px`;\r\n        emoji.style.pointerEvents = 'none';\r\n        emoji.style.zIndex = '10';\r\n        emoji.style.animation = `emojiFall ${duration}s ease-in-out forwards`;\r\n        \r\n        container.appendChild(emoji);\r\n        \r\n        // 动画结束后移除\r\n        setTimeout(() => {\r\n            emoji.remove();\r\n        }, duration * 1000);\r\n    }\r\n}\r\n\r\n// 页面加载完成后初始化\r\nwindow.onload = initPage;\r\n"],"names":["gifts","currentGiftIndex","quill","audio","audioFile","audioUrl","cropper","currentFile","editId","SERVER_URL","loadFromLocalStorage","savedData","localStorage","getItem","data","JSON","parse","urlParts","fileName","audioName","split","length","document","getElementById","textContent","musicFilenameElement","style","color","unload","Howl","src","loop","volume","parseFloat","value","theme","body","classList","remove","add","colorBtns","querySelectorAll","forEach","btn","dataset","siteTitle","letterTitle","letterContent","root","innerHTML","renderGifts","error","console","saveToLocalStorage","currentTheme","contains","name","setItem","stringify","log","saveEditState","response","fetch","method","headers","result","json","success","showSaveStatus","updateCurrentEditId","message","saveStatus","createElement","id","cssText","appendChild","opacity","transform","setTimeout","loadEditState","loadEditId","uploadFileToServer","file","Promise","resolve","reject","formData","FormData","append","then","ok","Error","url","catch","initFontSelector","fontSelect","fontPreview","addEventListener","selectedFont","fontFamily","editor","querySelector","giftNotes","note","initPage","initQuill","initColorPicker","initGiftManagement","initMusicPlayer","initGenerateButtons","initModals","initSortable","giftGrid","urlEditId","urlParams","URLSearchParams","window","location","search","get","initEmojiRain","Quill","modules","toolbar","placeholder","formats","defaultFont","on","fontSize","b","className","openGiftModal","display","currentMediaPreview","mediaPreviewContent","closeGiftModal","handleFileSelect","e","target","files","type","startsWith","openCropModal","saveGiftWithFile","reader","FileReader","onload","img","destroy","Cropper","aspectRatio","viewMode","dragMode","autoCropArea","cropBoxMovable","cropBoxResizable","readAsDataURL","closeCropModal","croppedFile","isAddingGift","confirmCrop","canvas","getCroppedCanvas","width","height","fillColor","imageSmoothingEnabled","toBlob","blob","File","lastModified","Date","now","alert","noteInput","gift","push","saveGift","fileInput","index","giftItem","mediaElement","addSingleEventListeners","tagName","parseInt","deleteBtn","closest","isNaN","previewImage","play","stopPropagation","editGift","confirmAndDelete","splice","deleteGift","confirmed","confirm","previewShowPage","generateShowPackage","previewContent","html","showData","map","editLink","shareUrl","navigator","clipboard","writeText","clipboardError","currentEditIdElement","giftModal","previewModal","cropModal","loadEditBtn","inputEditId","editIdInput","trim","Sortable","animation","ghostClass","chosenClass","dragClass","onStart","evt","draggedElement","item","onEnd","draggedGift","oldIndex","newIndex","click","playing","pause","emojis","Math","random","createEmojiRain","container","existingEmojis","emojiCount","floor","i","emoji","left","duration","position","top","pointerEvents","zIndex"],"version":3,"file":"edit.94cbf3ab.js.map"}