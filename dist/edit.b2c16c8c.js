let gifts=[],currentGiftIndex=-1,quill=null,audio=null,audioFile=null,audioUrl=null,cropper=null,currentFile=null,editId=null;const SERVER_URL="http://localhost:3000";function loadFromLocalStorage(){let e=localStorage.getItem("giftLetterData");if(e)try{let t=JSON.parse(e);if(gifts=t.gifts||[],audioUrl=t.audioUrl||null){let e,o=t.audioName||(e=audioUrl.split("/"))[e.length-1];document.getElementById("music-info").textContent=o;let n=document.getElementById("music-filename");n&&(n.textContent=o,n.style.color="#666"),audio&&audio.unload(),audio=new Howl({src:[audioUrl],loop:!0,volume:parseFloat(document.getElementById("volume").value)})}else{document.getElementById("music-info").textContent="Êú™ÈÄâÊã©";let e=document.getElementById("music-filename");e&&(e.textContent="Êú™ÈÄâÊã©",e.style.color="#666")}t.theme&&(document.body.classList.remove("pink","white","blue"),document.body.classList.add(t.theme),document.querySelectorAll(".color-btn").forEach(e=>{e.dataset.color===t.theme?e.classList.add("active"):e.classList.remove("active")})),t.siteTitle&&(document.getElementById("site-title").value=t.siteTitle),t.letterTitle&&(document.getElementById("letter-title").value=t.letterTitle),t.letterContent&&quill&&(quill.root.innerHTML=t.letterContent),renderGifts()}catch(e){console.error("Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:",e)}}function saveToLocalStorage(){let e=document.body.classList.contains("pink")?"pink":document.body.classList.contains("white")?"white":"blue",t={gifts:gifts,audioUrl:audioUrl,audioName:audioFile?audioFile.name:null,siteTitle:document.getElementById("site-title").value,letterTitle:document.getElementById("letter-title").value,letterContent:quill?quill.root.innerHTML:"",theme:e};localStorage.setItem("giftLetterData",JSON.stringify(t)),console.log("Êï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®")}async function saveEditState(){try{let e=document.body.classList.contains("pink")?"pink":document.body.classList.contains("white")?"white":"blue",t={editId:editId,gifts:gifts,audioUrl:audioUrl,audioName:audioFile?audioFile.name:null,siteTitle:document.getElementById("site-title").value,letterTitle:document.getElementById("letter-title").value,letterContent:quill?quill.root.innerHTML:"",theme:e},o=await fetch(`${SERVER_URL}/api/save-edit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),n=await o.json();if(n.success)return editId=n.editId,console.log("ÁºñËæëÁä∂ÊÄÅÂ∑≤‰øùÂ≠òÂà∞ÂêéÁ´Ø"),showSaveStatus("üíæ ÁºñËæëÁä∂ÊÄÅ‰øùÂ≠òÊàêÂäüÂï¶ÔΩû"),updateCurrentEditId(),n.editId}catch(e){console.error("‰øùÂ≠òÁºñËæëÁä∂ÊÄÅÂ§±Ë¥•:",e)}return null}function showSaveStatus(e){let t=document.getElementById("save-status");t||((t=document.createElement("div")).id="save-status",t.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(-20px);
        `,document.body.appendChild(t)),t.textContent=e,t.style.opacity="1",t.style.transform="translateY(0)",setTimeout(()=>{t.style.opacity="0",t.style.transform="translateY(-20px)"},3e3)}async function loadEditState(e){try{let t=await fetch(`${SERVER_URL}/api/load-edit?editId=${e}`),o=await t.json();if(o.success){let e=o.data;if(editId=e.editId,gifts=e.gifts||[],audioUrl=e.audioUrl||null){let t,o=e.audioName||(t=audioUrl.split("/"))[t.length-1];document.getElementById("music-info").textContent=o;let n=document.getElementById("music-filename");n&&(n.textContent=o,n.style.color="#666"),audio&&audio.unload(),audio=new Howl({src:[audioUrl],loop:!0,volume:parseFloat(document.getElementById("volume").value)})}else{document.getElementById("music-info").textContent="Êú™ÈÄâÊã©";let e=document.getElementById("music-filename");e&&(e.textContent="Êú™ÈÄâÊã©",e.style.color="#666")}return e.theme&&(document.body.classList.remove("pink","white","blue"),document.body.classList.add(e.theme),document.querySelectorAll(".color-btn").forEach(t=>{t.dataset.color===e.theme?t.classList.add("active"):t.classList.remove("active")})),e.siteTitle&&(document.getElementById("site-title").value=e.siteTitle),e.letterTitle&&(document.getElementById("letter-title").value=e.letterTitle),e.letterContent&&quill&&(quill.root.innerHTML=e.letterContent),renderGifts(),showSaveStatus("üîÑ ÁºñËæëÁä∂ÊÄÅÊÅ¢Â§çÊàêÂäüÂï¶ÔΩû"),!0}}catch(e){console.error("Âä†ËΩΩÁºñËæëÁä∂ÊÄÅÂ§±Ë¥•:",e),showSaveStatus("Âä†ËΩΩÁºñËæëÁä∂ÊÄÅÂ§±Ë¥•")}return!1}function uploadFileToServer(e){return new Promise((t,o)=>{let n=new FormData;n.append("file",e),fetch(`${SERVER_URL}/api/upload`,{method:"POST",body:n}).then(e=>{if(!e.ok)throw Error("Upload failed");return e.json()}).then(e=>{e.error?o(e.error):t(e.url)}).catch(e=>{console.error("Upload error:",e),o(e)})})}function initFontSelector(){let e=document.getElementById("font-select"),t=document.getElementById("font-preview");e&&t&&(e.addEventListener("change",function(){let e=this.value;if(t.style.fontFamily=e,document.body.style.fontFamily=e,quill){let t=document.querySelector(".ql-editor");t&&(t.style.fontFamily=e)}document.querySelectorAll(".gift-note").forEach(t=>{t.style.fontFamily=e}),console.log("Â≠ó‰ΩìÂ∑≤Êõ¥Êñ∞‰∏∫:",e)}),t.style.fontFamily=e.value)}function initPage(){initQuill(),initColorPicker(),initGiftManagement(),initMusicPlayer(),initGenerateButtons(),initModals(),initSortable(),initFontSelector();let e=document.getElementById("gift-grid");e.innerHTML=e.innerHTML;let t=new URLSearchParams(window.location.search).get("editId");t?setTimeout(()=>{loadEditState(t)},500):loadFromLocalStorage(),initEmojiRain()}function initQuill(){(quill=new Quill("#letter-content",{theme:"snow",modules:{toolbar:[["bold","italic","underline"],["blockquote","code-block"],[{header:1},{header:2}],[{list:"ordered"},{list:"bullet"}],[{color:[]},{background:[]}],[{align:[]}],["clean"]]},placeholder:"ËØ∑ËæìÂÖ•‰π¶‰ø°ÂÜÖÂÆπ...",formats:["font","size","bold","italic","underline","strike","blockquote","code-block","header","list","bullet","indent","link","image","color","background","align"],defaultFont:"Comic Neue"})).on("editor-change",function(){let e=document.querySelector(".ql-editor");e&&(e.style.fontFamily="'Comic Neue', 'Nunito', 'Microsoft YaHei', Arial, sans-serif",e.style.fontSize="18px")})}function initColorPicker(){let e=document.querySelectorAll(".color-btn");e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active")),t.classList.add("active");let o=t.dataset.color;document.body.className=o})})}function initGiftManagement(){document.getElementById("add-gift").addEventListener("click",()=>{currentGiftIndex=-1,openGiftModal()})}function openGiftModal(){if(document.getElementById("gift-modal").style.display="block",document.getElementById("gift-file").value="",-1===currentGiftIndex){document.getElementById("gift-note").value="";let e=document.getElementById("current-media-preview"),t=document.getElementById("media-preview-content");e.style.display="none",t.innerHTML=""}}function closeGiftModal(){document.getElementById("gift-modal").style.display="none"}function handleFileSelect(e){let t=e.target.files[0];t&&(currentFile=t,t.type.startsWith("image/")?openCropModal(t):saveGiftWithFile(t))}function openCropModal(e){let t=new FileReader;t.onload=function(e){let t=document.getElementById("crop-image");t.src=e.target.result,cropper&&cropper.destroy(),cropper=new Cropper(t,{aspectRatio:1,viewMode:1,dragMode:"move",autoCropArea:.8,cropBoxMovable:!0,cropBoxResizable:!0}),document.getElementById("crop-modal").style.display="block"},t.readAsDataURL(e)}function closeCropModal(){cropper&&(cropper.destroy(),cropper=null),document.getElementById("crop-modal").style.display="none",currentFile=null}let croppedFile=null,isAddingGift=!1;async function confirmCrop(){if(cropper&&!isAddingGift)try{console.log("ÂºÄÂßãË£ÅÂâ™ÂõæÁâá"),isAddingGift=!0,cropper.getCroppedCanvas({width:800,height:800,fillColor:"#fff",imageSmoothingEnabled:!0}).toBlob(function(e){console.log("Ë£ÅÂâ™ÂÆåÊàêÔºåÂàõÂª∫Êñá‰ª∂ÂØπË±°"),croppedFile=new File([e],currentFile.name,{type:currentFile.type,lastModified:Date.now()}),console.log("ÂÖ≥Èó≠Ë£ÅÂâ™ÂºπÁ™ó"),closeCropModal(),console.log("ÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ"),alert("‚úÇÔ∏è Ë£ÅÂâ™ÂÆåÊàêÂï¶ÔΩûËØ∑Â°´ÂÜôÁ§ºÁâ©Â§áÊ≥®ÂêéÁÇπÂáª‰øùÂ≠òÂì¶ üéÅ"),console.log("Ë£ÅÂâ™ÊµÅÁ®ãÂÆåÊàêÔºåÁ§ºÁâ©ÁºñËæëÂºπÁ™óÂ∫îËØ•‰ªçÁÑ∂ÊâìÂºÄ"),isAddingGift=!1},currentFile.type)}catch(e){console.error("Ë£ÅÂâ™Â§±Ë¥•:",e),alert("üò¢ Ë£ÅÂâ™Â§±Ë¥•‰∫ÜÔΩûËØ∑ÂÜçËØï‰∏ÄÊ¨°Âêß üí™"),isAddingGift=!1}}async function saveGiftWithFile(e){if(isAddingGift)return;let t=document.getElementById("gift-note").value;try{let o;console.log("ÂºÄÂßã‰∏ä‰º†Êñá‰ª∂:",e.name),isAddingGift=!0;let n=await uploadFileToServer(e);console.log("Êñá‰ª∂‰∏ä‰º†ÊàêÂäüÔºåURL:",n),-1===currentGiftIndex?(o={id:Date.now(),file:e,url:n,note:t,type:e.type.startsWith("image/")?"image":"video"},gifts.push(o),console.log("Êñ∞Á§ºÁâ©Ê∑ªÂä†ÊàêÂäü:",o.id)):((o=gifts[currentGiftIndex]).file=e,o.url=n,o.note=t,o.type=e.type.startsWith("image/")?"image":"video",console.log("Á§ºÁâ©ÁºñËæëÊàêÂäü:",o.id)),renderGifts(),closeGiftModal(),saveToLocalStorage(),showSaveStatus("üéâ Á§ºÁâ©‰øùÂ≠òÊàêÂäüÂï¶ÔΩû"),console.log("Á§ºÁâ©‰øùÂ≠òÂÆåÊàê")}catch(e){console.error("‰øùÂ≠òÁ§ºÁâ©Â§±Ë¥•:",e),console.error("ÈîôËØØËØ¶ÊÉÖ:",e.message),alert("üò¢ ‰∏ä‰º†Â§±Ë¥•‰∫ÜÔΩûËØ∑ÂÜçËØï‰∏ÄÊ¨°Âêß üí™\n\nÈîôËØØ‰ø°ÊÅØ: "+e.message)}finally{isAddingGift=!1,croppedFile=null}}function saveGift(){if(isAddingGift)return void alert("‚è∞ Á§ºÁâ©Ê≠£Âú®Ê∑ªÂä†‰∏≠ÔºåËØ∑Á®çÂÄôÂì¶ÔΩû üéÄ");let e=document.getElementById("gift-file"),t=document.getElementById("gift-note").value;if(console.log("ÂºÄÂßã‰øùÂ≠òÁ§ºÁâ©"),console.log("currentGiftIndex:",currentGiftIndex),console.log("fileInput.files.length:",e.files.length),console.log("croppedFile:",croppedFile),console.log("note:",t),-1!==currentGiftIndex&&!e.files.length&&!croppedFile){console.log("ÁºñËæëÁé∞ÊúâÁ§ºÁâ©ÔºåÂè™Êõ¥Êñ∞Â§áÊ≥®"),gifts[currentGiftIndex].note=t,renderGifts(),closeGiftModal(),saveToLocalStorage(),showSaveStatus("üìù Á§ºÁâ©Â§áÊ≥®Êõ¥Êñ∞ÊàêÂäüÂï¶ÔΩû");return}if(croppedFile)console.log("‰ΩøÁî®Ë£ÅÂâ™ÂêéÁöÑÊñá‰ª∂‰øùÂ≠òÁ§ºÁâ©"),saveGiftWithFile(croppedFile);else if(e.files.length)console.log("Â§ÑÁêÜÁî®Êà∑ÈÄâÊã©ÁöÑÊñá‰ª∂"),handleFileSelect({target:e});else{console.log("Ê≤°ÊúâÈÄâÊã©Êñá‰ª∂"),alert("üéÅ ËØ∑ÂÖàÈÄâÊã©Á§ºÁâ©Á¥†ÊùêÂì¶ÔΩû");return}}function renderGifts(){let e=document.getElementById("gift-grid");e.innerHTML="",gifts.forEach((t,o)=>{let n=document.createElement("div");n.className="gift-item";let l="";l="image"===t.type?`<img src="${t.url}" alt="\u{793C}\u{7269}\u{56FE}\u{7247}" class="gift-media">
            <button onclick="previewImage(${o})" class="preview-btn">\u{9884}\u{89C8}</button>`:`<video src="${t.url}" class="gift-media">
            <button onclick="this.previousElementSibling.play()" class="preview-btn">\u{64AD}\u{653E}</button>`,n.innerHTML=`
            <div class="gift-media-container">
                ${l}
            </div>
            <div class="gift-note">${t.note||"Êó†Â§áÊ≥®"}</div>
            <div class="gift-actions">
                <button onclick="editGift(${o})" class="edit-btn">\u{7F16}\u{8F91}</button>
                <button onclick="confirmAndDelete(${o})" class="delete-btn">\u{5220}\u{9664}</button>
            </div>
        `,e.appendChild(n)})}function addSingleEventListeners(){let e=document.getElementById("gift-grid");e.addEventListener("click",function(e){if("IMG"===e.target.tagName||"VIDEO"===e.target.tagName){let t=parseInt(e.target.closest(".gift-item").querySelector(".delete-btn").dataset.index);isNaN(t)||("IMG"===e.target.tagName?previewImage(t):"VIDEO"===e.target.tagName&&e.target.play())}}),e.addEventListener("click",function(e){if(e.target.classList.contains("edit-btn")){e.stopPropagation();let t=parseInt(e.target.dataset.index);isNaN(t)||editGift(t)}})}function confirmAndDelete(e){console.log("Âà†Èô§ÊåâÈíÆË¢´ÁÇπÂáªÔºåÁ¥¢Âºï:",e),console.log("ÂΩìÂâçgiftsÊï∞ÁªÑÈïøÂ∫¶:",gifts.length),e>=0&&e<gifts.length?(gifts.splice(e,1),console.log("Âà†Èô§ÂêégiftsÊï∞ÁªÑÈïøÂ∫¶:",gifts.length),renderGifts(),saveToLocalStorage(),showSaveStatus("üóëÔ∏è Á§ºÁâ©Âà†Èô§ÊàêÂäüÂï¶ÔΩû")):(console.error("Á¥¢ÂºïË∂ÖÂá∫ËåÉÂõ¥:",e),alert("üò¢ Âà†Èô§Â§±Ë¥•‰∫ÜÔΩûÁ¥¢ÂºïË∂ÖÂá∫ËåÉÂõ¥Âï¶ üí™"))}function editGift(e){currentGiftIndex=e;let t=gifts[e];document.getElementById("gift-note").value=t.note;let o=document.getElementById("current-media-preview"),n=document.getElementById("media-preview-content");t&&t.url?(o.style.display="block","image"===t.type?n.innerHTML=`<img src="${t.url}" alt="\u{793C}\u{7269}\u{56FE}\u{7247}" style="max-width: 100%; max-height: 200px; border-radius: 3px;">`:"video"===t.type&&(n.innerHTML=`<video src="${t.url}" style="max-width: 100%; max-height: 200px; border-radius: 3px;" controls></video>`)):(o.style.display="none",n.innerHTML=""),openGiftModal()}function deleteGift(e){console.log("Âà†Èô§ÊåâÈíÆË¢´ÁÇπÂáªÔºåÁ¥¢Âºï:",e),console.log("ÂΩìÂâçgiftsÊï∞ÁªÑÈïøÂ∫¶:",gifts.length),console.log("ÂΩìÂâçgiftsÊï∞ÁªÑ:",gifts);let t=confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Á§ºÁâ©ÂêóÔºüÂà†Èô§ÂêéÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ");console.log("Áî®Êà∑Á°ÆËÆ§:",t),t?(console.log("ÊâßË°åÂà†Èô§Êìç‰ΩúÔºåÁ¥¢Âºï:",e),e>=0&&e<gifts.length?(gifts.splice(e,1),console.log("Âà†Èô§ÂêégiftsÊï∞ÁªÑÈïøÂ∫¶:",gifts.length),renderGifts(),saveToLocalStorage(),showSaveStatus("Á§ºÁâ©Âà†Èô§ÊàêÂäü")):(console.error("Á¥¢ÂºïË∂ÖÂá∫ËåÉÂõ¥:",e),alert("Âà†Èô§Â§±Ë¥•ÔºöÁ¥¢ÂºïË∂ÖÂá∫ËåÉÂõ¥"))):console.log("Áî®Êà∑ÂèñÊ∂àÂà†Èô§Êìç‰Ωú")}function previewImage(e){let t=gifts[e];"image"===t.type&&console.log("È¢ÑËßàÂõæÁâá:",t.url)}function initGenerateButtons(){document.getElementById("preview-btn").addEventListener("click",function(){previewShowPage()}),document.getElementById("generate-btn").addEventListener("click",function(){generateShowPackage()})}function previewShowPage(){let e=document.getElementById("preview-content"),t=document.getElementById("site-title").value,o=document.getElementById("letter-title").value,n=quill.root.innerHTML,l=`
        <h1>${t}</h1>
        <h2>\u{793C}\u{7269}</h2>
        <div class="gift-grid">
    `;gifts.forEach(e=>{let t="";t="image"===e.type?`<img src="${e.url}" alt="\u{793C}\u{7269}\u{56FE}\u{7247}" class="gift-media">`:`<video src="${e.url}" class="gift-media"></video>`,l+=`
            <div class="gift-item">
                <div class="gift-media-container">
                    ${t}
                </div>
                <div class="gift-note">${e.note||"Êó†Â§áÊ≥®"}</div>
            </div>
        `}),e.innerHTML=l+=`
        </div>
        <h2>${o}</h2>
        <div class="letter-content">${n}</div>
        <div class="music-player">
            <span>\u{80CC}\u{666F}\u{97F3}\u{4E50}: ${audioFile?audioFile.name:"Êú™ÈÄâÊã©"}</span>
        </div>
    `,document.getElementById("preview-modal").style.display="block"}async function generateShowPackage(){try{await saveEditState();let e=document.getElementById("site-title").value||"ÊàëÁöÑÁ§ºÁâ©",t=document.getElementById("letter-title").value||"ÁîüÊó•Á•ùÁ¶è",o=quill.root.innerHTML,n=document.body.classList.contains("pink")?"pink":document.body.classList.contains("white")?"white":"blue",l={siteTitle:e,letterTitle:t,letterContent:o,gifts:gifts.map(e=>({id:e.id,url:e.url,note:e.note,type:e.type})),audioUrl:audioUrl,audioName:audioFile?audioFile.name:null,theme:n},i=await fetch(`${SERVER_URL}/api/save-show`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),a=await i.json();if(a.success){let e="";editId&&(e=`<p style="margin-top: 10px;">\u{7F16}\u{8F91}\u{94FE}\u{63A5}\u{FF08}\u{7528}\u{4E8E}\u{540E}\u{7EED}\u{4FEE}\u{6539}\u{FF09}\u{FF1A}</p>
                <p style="background-color: #f0f0f0; padding: 15px; border-radius: 5px; word-break: break-all;">
                    ${SERVER_URL}/edit.html?editId=${editId}
                </p>`),document.getElementById("generate-info").innerHTML=`
                <p style="color: green;">\u{751F}\u{6210}\u{6210}\u{529F}\u{FF01}\u{8BF7}\u{5C06}\u{4EE5}\u{4E0B}\u{94FE}\u{63A5}\u{5206}\u{4EAB}\u{7ED9}\u{5BF9}\u{65B9}\u{FF1A}</p>
                <p style="background-color: #f0f0f0; padding: 15px; border-radius: 5px; word-break: break-all;">
                    ${a.shareUrl}
                </p>
                ${e}
                <p style="color: blue;">\u{6CE8}\u{610F}\u{FF1A}\u{6B64}\u{94FE}\u{63A5}\u{6C38}\u{4E45}\u{6709}\u{6548}\u{FF0C}\u{8BF7}\u{59A5}\u{5584}\u{4FDD}\u{7BA1}\u{3002}</p>
            `;try{await navigator.clipboard.writeText(a.shareUrl),document.getElementById("generate-info").innerHTML+=`
                    <p style="color: green; font-size: 14px;">\u{2705} \u{5206}\u{4EAB}\u{94FE}\u{63A5}\u{5DF2}\u{590D}\u{5236}\u{5230}\u{526A}\u{8D34}\u{677F}</p>
                `}catch(e){console.log("Êó†Ê≥ïÂ§çÂà∂Âà∞Ââ™Ë¥¥Êùø:",e)}}else document.getElementById("generate-info").innerHTML=`
                <p style="color: red;">\u{751F}\u{6210}\u{5931}\u{8D25}: ${a.error}</p>
            `}catch(e){console.error("ÁîüÊàêÂàÜ‰∫´ÈìæÊé•Â§±Ë¥•:",e),document.getElementById("generate-info").innerHTML=`
            <p style="color: red;">\u{751F}\u{6210}\u{5931}\u{8D25}\u{FF0C}\u{8BF7}\u{91CD}\u{8BD5}\u{3002}</p>
        `}}function updateCurrentEditId(){let e=document.getElementById("current-edit-id");e&&(editId?e.textContent=`\u{5F53}\u{524D}\u{7F16}\u{8F91}ID: ${editId} (\u{53EF}\u{7528}\u{4E8E}\u{540E}\u{7EED}\u{6062}\u{590D}\u{7F16}\u{8F91})`:e.textContent="Êú™‰øùÂ≠òÁºñËæëÁä∂ÊÄÅ")}function initModals(){document.querySelector("#gift-modal .close").addEventListener("click",closeGiftModal),document.querySelector("#preview-modal .close").addEventListener("click",function(){document.getElementById("preview-modal").style.display="none"}),document.querySelector("#crop-modal .close").addEventListener("click",closeCropModal),document.getElementById("cancel-crop").addEventListener("click",closeCropModal),document.getElementById("confirm-crop").addEventListener("click",confirmCrop),window.addEventListener("click",function(e){let t=document.getElementById("gift-modal"),o=document.getElementById("preview-modal"),n=document.getElementById("crop-modal");e.target===t&&closeGiftModal(),e.target===o&&(o.style.display="none"),e.target===n&&closeCropModal()}),document.getElementById("save-gift").addEventListener("click",saveGift),document.getElementById("gift-file").addEventListener("change",handleFileSelect),document.getElementById("site-title").addEventListener("input",saveToLocalStorage),document.getElementById("letter-title").addEventListener("input",saveToLocalStorage),setTimeout(()=>{quill&&(quill.on("text-change",saveToLocalStorage),console.log("Â∑≤Ê∑ªÂä†QuillÊñáÊú¨ÂèòÂåñÁõëÂê¨"))},500);let e=document.getElementById("load-edit-btn");e&&e.addEventListener("click",function(){let e=document.getElementById("edit-id-input").value.trim();e?loadEditState(e):alert("ËØ∑ËæìÂÖ•ÁºñËæëID")})}function initSortable(){new Sortable(document.getElementById("gift-grid"),{animation:150,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",onStart:function(e){e.item.style.opacity="0.5"},onEnd:function(e){e.item.style.opacity="1";let t=gifts.splice(e.oldIndex,1)[0];gifts.splice(e.newIndex,0,t),renderGifts(),saveToLocalStorage(),showSaveStatus("Á§ºÁâ©È°∫Â∫èÂ∑≤Êõ¥Êñ∞")}})}function initMusicPlayer(){document.getElementById("music-upload-btn").addEventListener("click",function(){document.getElementById("music-upload").click()}),document.getElementById("music-upload").addEventListener("change",async function(e){let t=e.target.files[0];if(t&&t.type.startsWith("audio/"))try{document.getElementById("music-info").textContent="‰∏ä‰º†‰∏≠...";let e=await uploadFileToServer(t);audio?(audio.unload(),showSaveStatus("üéµ Èü≥‰πêÂ∑≤ÊõøÊç¢ÔΩû")):showSaveStatus("üéµ Èü≥‰πê‰øùÂ≠òÊàêÂäüÂï¶ÔΩû"),audioFile=t,audioUrl=e,document.getElementById("music-info").textContent=t.name;let o=document.getElementById("music-filename");o&&(o.textContent=t.name,o.style.color="#666"),audio=new Howl({src:[e],loop:!0,volume:parseFloat(document.getElementById("volume").value)}),saveToLocalStorage()}catch(e){console.error("‰∏ä‰º†Èü≥‰πêÂ§±Ë¥•:",e),document.getElementById("music-info").textContent="‰∏ä‰º†Â§±Ë¥•",alert("üò¢ Èü≥‰πê‰∏ä‰º†Â§±Ë¥•‰∫ÜÔΩûËØ∑ÂÜçËØï‰∏ÄÊ¨°Âêß üí™")}else t&&alert("üéµ ËØ∑ÈÄâÊã©Èü≥È¢ëÊñá‰ª∂Âì¶ÔΩû")}),document.getElementById("clear-music").addEventListener("click",function(){audio&&(audio.unload(),audio=null),audioFile=null,audioUrl=null,document.getElementById("music-info").textContent="Êú™ÈÄâÊã©",document.getElementById("play-btn").textContent="Êí≠Êîæ";let e=document.getElementById("music-filename");e&&(e.textContent="Êú™ÈÄâÊã©",e.style.color="#666"),saveToLocalStorage(),showSaveStatus("üéµ Èü≥‰πêÂ∑≤Ê∏ÖÈô§ÔΩû")}),document.getElementById("play-btn").addEventListener("click",function(){audio?audio.playing()?(audio.pause(),this.textContent="Êí≠Êîæ"):(audio.play(),this.textContent="ÊöÇÂÅú"):showSaveStatus("üéµ ËØ∑ÂÖàÈÄâÊã©Èü≥‰πêÂì¶ÔΩû")}),document.getElementById("volume").addEventListener("input",function(){let e=parseFloat(this.value);audio&&audio.volume(e)})}function initEmojiRain(){let e=document.querySelector(".letter-content"),t=["üòä","ü•∞","ü§©","üåü","üéÄ","üéâ","‚ú®","üíñ","üå∏","ü¶ã","üåà","üíù","üíó","üíì","üíû"];quill&&quill.on("text-change",function(){Math.random()>.7&&createEmojiRain(e,t)})}function createEmojiRain(e,t){if(e.querySelectorAll(".emoji-rain").length>10)return;let o=Math.floor(3*Math.random())+1;for(let n=0;n<o;n++){let o=document.createElement("div");o.className="emoji-rain",o.textContent=t[Math.floor(Math.random()*t.length)];let n=100*Math.random(),l=20*Math.random()+20,i=3*Math.random()+2;o.style.position="absolute",o.style.left=`${n}%`,o.style.top="-30px",o.style.fontSize=`${l}px`,o.style.pointerEvents="none",o.style.zIndex="10",o.style.animation=`emojiFall ${i}s ease-in-out forwards`,e.appendChild(o),setTimeout(()=>{o.remove()},1e3*i)}}window.onload=initPage;
//# sourceMappingURL=edit.b2c16c8c.js.map
